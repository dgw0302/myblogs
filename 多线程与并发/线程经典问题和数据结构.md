---
title: æ•°æ®ç»“æ„&&å¹¶å‘
categories:
  - å¤šçº¿ç¨‹ä¸å¹¶å‘
tags:
  - çº¿ç¨‹æ•°æ®ç»“æ„é—®é¢˜
abbrlink: 55249
date: 2022-04-13 00:00:00
---





[TOC]



# å¹¶å‘

## ä¸¤ä¸ªçº¿ç¨‹è½®æµæ‰“å°å¥‡å¶æ•°ã€‚

```java
public class Test {
    private  static int count = 0;
    private static final Object object = new Object();
    public static void main(String[] args) {

        new Thread(new Runnable() {
            @Override
            public void run() {
                while (count < 100) {
                    synchronized (object) {
                        if(count % 2 == 0) {
                            System.out.println(Thread.currentThread().getName() +"  "+ count++ +"å¶æ•°çº¿ç¨‹");
                        }
                    }
                }
            }
        }).start();


        new Thread(new Runnable() {
            @Override
            public void run() {
                while (count < 100) {
                    synchronized (object) {
                        if(count % 2 != 0) {
                            System.out.println(Thread.currentThread().getName() + " " + count++ +"å¥‡æ•°çº¿ç¨‹");
                        }
                    }
                }
            }
        }).start();

    }
}
```



## ä¸‰ä¸ªçº¿ç¨‹è½®æµæ‰“å°ABC

å®Œæ•´ä»£ç å¦‚ä¸‹

```java
public class ABC2 {

    private static Lock lock = new ReentrantLock();
    private static Condition A = lock.newCondition();
    private static Condition B = lock.newCondition();
    private static Condition C = lock.newCondition();
    private static int count = 0;
    static class ThreadA extends Thread {
        @Override
        public void run() {
            try {
                lock.lock();
                for (int i = 0; i < 10; i++) {
                    while (count % 3 != 0)//æ³¨æ„è¿™é‡Œæ˜¯ä¸ç­‰äº0ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨count % 3ä¸º0ä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹ä¸€ç›´é˜»å¡çŠ¶æ€
                        A.await(); // Aé‡Šæ”¾locké”
                    System.out.print("A");
                    count++;
                    B.signal(); // Aæ‰§è¡Œå®Œå”¤é†’Bçº¿ç¨‹
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                lock.unlock();
            }
        }
    }


    static class ThreadB extends Thread {
        @Override
        public void run() {
            try {
                lock.lock();
                for (int i = 0; i < 10; i++) {
                    while (count % 3 != 1)
                        B.await();// Bé‡Šæ”¾locké”ï¼Œå½“å‰é¢Açº¿ç¨‹æ‰§è¡Œåä¼šé€šè¿‡B.signal()å”¤é†’è¯¥çº¿ç¨‹
                    System.out.print("B");
                    count++;
                    C.signal();// Bæ‰§è¡Œå®Œå”¤é†’Cçº¿ç¨‹
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                lock.unlock();
            }
        }
    }
    
    
    static class ThreadC extends Thread {
        @Override
        public void run() {
            try {
                lock.lock();
                for (int i = 0; i < 10; i++) {
                    while (count % 3 != 2)
                        C.await();// Cé‡Šæ”¾locké”ï¼Œå½“å‰é¢Bçº¿ç¨‹æ‰§è¡Œåä¼šé€šè¿‡C.signal()å”¤é†’è¯¥çº¿ç¨‹
                    System.out.print("C");
                    count++;
                    A.signal();// Cæ‰§è¡Œå®Œå”¤é†’Açº¿ç¨‹
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                lock.unlock();
            }
        }
    }
    
    public static void main(String[] args) {
        new ThreadA().start();
        new ThreadB().start();
        new ThreadC().start();

    }
    
}
```





åˆ†æå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹A

å…¨æ–‡ç»´æŠ¤ä¸€ä¸ªcountå€¼ï¼Œå½“å€¼å–æ¨¡0æ‰“å°Aå¹¶è‡ªå¢ï¼ŒBã€Cä¹Ÿæ˜¯å¦‚æ­¤



æœ‰A B Cä¸‰ä¸ªcondition,å†…éƒ¨éƒ½ç»´æŠ¤ä¸€ä¸ªæ¡ä»¶é˜Ÿåˆ—

```java
static class ThreadA extends Thread {
    @Override
    public void run() {
        try {
            lock.lock();
            for (int i = 0; i < 10; i++) {//ä¸€å…±æ‰“å°10æ¬¡ï¼Œçº¿ç¨‹ä¼šåœ¨ä¸æ–­å¾ªç¯ï¼Œåˆ°å®ƒæ‰“å°å°±æ‰“å°ï¼Œè¦ä¹ˆå°±é˜»å¡ç­‰å¾…ä¸‹æ¬¡æ‰“å°ï¼Œç›´åˆ°å¾ªç¯å®Œ
                while (count % 3 != 0)//æ³¨æ„è¿™é‡Œæ˜¯ä¸ç­‰äº0ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨count % 3ä¸º0ä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹ä¸€ç›´é˜»å¡çŠ¶æ€
                    A.await(); // å¦‚æœç°åœ¨ä¸æ˜¯è½®åˆ°åˆ°ä»–æ‰“å°ï¼Œé‚£ä¹ˆå°±åŠ å…¥æ¡ä»¶é˜Ÿåˆ—ï¼Œå¹¶é‡Šæ”¾é”èµ„æºï¼Œå¹¶ä¸”é˜»å¡ã€‚
                
                System.out.print("A");//åˆ°è¿™å„¿äº†è¯´æ˜è½®åˆ°ä»–æ‰“å°äº†
                count++;//åŠ 1
                B.signal(); // æ‰“å°å®Œå”¤é†’å®ƒä¹‹ååº”è¯¥æ‰“å°çš„çº¿ç¨‹ï¼Œå…·ä½“æ€æ ·å”¤é†’å‘¢ï¼Œè°ƒç”¨å…¶æ‰€åœ¨çš„condition,å°†å…¶åœ¨æ¡ä»¶é˜Ÿåˆ—é‡Œé¢çš„çº¿ç¨‹è°ƒè‡³CLHé˜Ÿåˆ—å»æŠ¢é”
                
            }
        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            lock.unlock();
        }
    }
}
```



**å½“å¯åŠ¨ä¸‰ä¸ªçº¿ç¨‹æ—¶ï¼Œä¸ºä»€ä¹ˆèƒ½æ§åˆ¶Açº¿ç¨‹ç¬¬ä¸€ä¸ªæ‰“å°Aå‘¢ï¼Œæ¯•ç«Ÿçº¿ç¨‹åŸºæœ¬ä¸Šæ˜¯åŒæ—¶å¯åŠ¨çš„ï¼Ÿ**



è§£é‡Š

```java
while (count % 3 != 0)//æ³¨æ„è¿™é‡Œæ˜¯ä¸ç­‰äº0ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨count % 3ä¸º0ä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹ä¸€ç›´é˜»å¡çŠ¶æ€
A.await(); // å¦‚æœç°åœ¨ä¸æ˜¯è½®åˆ°åˆ°ä»–æ‰“å°ï¼Œé‚£ä¹ˆå°±åŠ å…¥æ¡ä»¶é˜Ÿåˆ—ï¼Œå¹¶é‡Šæ”¾é”èµ„æºï¼Œå¹¶ä¸”é˜»å¡ã€‚
```

å°±åœ¨è¿™ä¸ªå¾ªç¯åˆ¤æ–­é€»è¾‘é‡Œé¢

å½“ä¸‰ä¸ªçº¿ç¨‹åŒæ—¶å¯åŠ¨ï¼Œè¿è¡Œåˆ°è‡ªå·±è¿™ä¸ªwhileå¾ªç¯é€»è¾‘æ—¶å€™ï¼Œåªæœ‰Açº¿ç¨‹èƒ½è·³è¿‡whileå¾ªç¯ï¼Œå…¶ä»–ä¸¤ä¸ªéƒ½åˆ°å…¶conditionæ‰€åœ¨çš„æ¡ä»¶é˜Ÿåˆ—é‡Œé¢äº†å¹¶ä¸”é˜»å¡ï¼Œç­‰å¾…å‰ä¸€ä¸ªæ‰“å°çº¿ç¨‹å»signal()å”¤é†’å®ƒ







å¤‡æ³¨ï¼šå¼€å§‹çš„æ—¶å€™å¯åŠ¨ä¸‰ä¸ªçº¿ç¨‹ï¼Œæ— è®ºæ˜¯è°å…ˆæ‹¿åˆ°é”ï¼Œå¦‚æœè½®ä¸åˆ°è‡ªå·±æ‰“å°ï¼Œéƒ½ä¼šè¢«è‡ªå·±é˜Ÿåˆ—çš„awaitæ–¹æ³•é˜»å¡ï¼Œé‡Šæ”¾é”ï¼Œå¹¶è¿›å…¥å¯¹åº”çš„conditionæ¡ä»¶é˜Ÿåˆ—ã€‚



å¦‚æœè½®åˆ°è‡ªå·±æ‰“å°äº†ï¼Œæ‰“å°å®Œä¹‹åï¼Œcount++,ä¼šè°ƒç”¨æ¥ä¸‹æ¥çš„çº¿ç¨‹å¯¹åº”çš„conditiné˜Ÿåˆ—signal,å”¤é†’çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯æŠŠé˜Ÿå¤´ç»“ç‚¹ç§»åŠ¨åˆ°AQSå†…éƒ¨çš„åŒæ­¥é˜Ÿåˆ—å»ç­‰å¾…è¢«å”¤é†’ï¼Œç„¶å**tryAcquireè·å–é”**ã€‚æ‹¿åˆ°é”äº†æ‰ä¼šè¿›è¡Œä¸‹é¢çš„é€»è¾‘ï¼Œå¦åˆ™åœ¨acquireQueuedæ–¹æ³•ä¼šä¸€ç›´è‡ªæ—‹ï¼ˆæ³¨æ„å½“å‰çº¿ç¨‹åœ¨ä¸‹ä¸€æ¬¡å¾ªç¯countå–æ¨¡ä¸æ˜¯è‡ªå·±ä¼šé‡Šæ”¾é”å¹¶é˜»å¡è‡ªå·±ï¼‰å¦‚æœå¯¹åº”çš„çº¿ç¨‹è¢«å”¤é†’äº†å¹¶è·å–åˆ°é”äº†ï¼Œä¹Ÿæ˜¯ç›¸åŒçš„é€»è¾‘ã€‚











# ç”Ÿäº§è€…æ¶ˆè´¹è€…å®ç°





## BlockingQueueå®ç°



BlockingQueueå³é˜»å¡é˜Ÿåˆ—ï¼Œä»é˜»å¡è¿™ä¸ªè¯å¯ä»¥çœ‹å‡ºï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å¯¹é˜»å¡é˜Ÿåˆ—çš„è®¿é—®å¯èƒ½ä¼šé€ æˆé˜»å¡ã€‚è¢«é˜»å¡çš„æƒ…å†µä¸»è¦æœ‰å¦‚ä¸‹ä¸¤ç§:

1. å½“é˜Ÿåˆ—æ»¡äº†çš„æ—¶å€™è¿›è¡Œå…¥é˜Ÿåˆ—æ“ä½œ
2. å½“é˜Ÿåˆ—ç©ºäº†çš„æ—¶å€™è¿›è¡Œå‡ºé˜Ÿåˆ—æ“ä½œ
   å› æ­¤ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å¯¹å·²ç»æ»¡äº†çš„é˜»å¡é˜Ÿåˆ—è¿›è¡Œå…¥é˜Ÿæ“ä½œæ—¶ä¼šé˜»å¡ï¼Œé™¤éæœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œäº†å‡ºé˜Ÿæ“ä½œï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªç©ºçš„é˜»å¡é˜Ÿåˆ—è¿›è¡Œå‡ºé˜Ÿæ“ä½œæ—¶ä¹Ÿä¼šé˜»å¡ï¼Œé™¤éæœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œäº†å…¥é˜Ÿæ“ä½œã€‚
   ä»ä¸Šå¯çŸ¥ï¼Œé˜»å¡é˜Ÿåˆ—æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
   ä¸‹é¢æ˜¯BlockingQueueæ¥å£çš„ä¸€äº›æ–¹æ³•:

| æ“ä½œ | æŠ›å¼‚å¸¸     | ç‰¹å®šå€¼   | é˜»å¡    | è¶…æ—¶                        |
| ---- | ---------- | -------- | ------- | --------------------------- |
| æ’å…¥ | add(o)     | offer(o) | put(o)  | offer(o, timeout, timeunit) |
| ç§»é™¤ | remove(o)  | poll(o)  | take(o) | poll(timeout, timeunit)     |
| æ£€æŸ¥ | element(o) | peek(o)  |         |                             |

è¿™å››ç±»æ–¹æ³•åˆ†åˆ«å¯¹åº”çš„æ˜¯ï¼š
1 . ThrowsExceptionï¼šå¦‚æœæ“ä½œä¸èƒ½é©¬ä¸Šè¿›è¡Œï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
2 . SpecialValueï¼šå¦‚æœæ“ä½œä¸èƒ½é©¬ä¸Šè¿›è¡Œï¼Œå°†ä¼šè¿”å›ä¸€ä¸ªç‰¹æ®Šçš„å€¼ï¼Œä¸€èˆ¬æ˜¯trueæˆ–è€…false
3 . Blocks:å¦‚æœæ“ä½œä¸èƒ½é©¬ä¸Šè¿›è¡Œï¼Œæ“ä½œä¼šè¢«é˜»å¡
4 . TimesOut:å¦‚æœæ“ä½œä¸èƒ½é©¬ä¸Šè¿›è¡Œï¼Œæ“ä½œä¼šè¢«é˜»å¡æŒ‡å®šçš„æ—¶é—´ï¼Œå¦‚æœæŒ‡å®šæ—¶é—´æ²¡æ‰§è¡Œï¼Œåˆ™è¿”å›ä¸€ä¸ªç‰¹æ®Šå€¼ï¼Œä¸€èˆ¬æ˜¯trueæˆ–è€…false
ä¸‹é¢æ¥çœ‹ç”±é˜»å¡é˜Ÿåˆ—å®ç°çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹,è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨take()å’Œput()æ–¹æ³•ï¼Œè¿™é‡Œç”Ÿäº§è€…å’Œç”Ÿäº§è€…ï¼Œæ¶ˆè´¹è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´ä¸å­˜åœ¨åŒæ­¥ï¼Œæ‰€ä»¥ä¼šå‡ºç°è¿ç»­ç”Ÿæˆå’Œè¿ç»­æ¶ˆè´¹çš„ç°è±¡

```java
import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.BlockingQueue;
/**
 * ä½¿ç”¨BlockingQueueå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹
 * @author ZGJ
 * @date 2017å¹´6æœˆ29æ—¥
 */
public class Test3 {
    private static Integer count = 0;
    //åˆ›å»ºä¸€ä¸ªé˜»å¡é˜Ÿåˆ—
    final BlockingQueue blockingQueue = new ArrayBlockingQueue<>(10);
    public static void main(String[] args) {
        Test3 test3 = new Test3();
        new Thread(test3.new Producer()).start();
        new Thread(test3.new Consumer()).start();
        new Thread(test3.new Producer()).start();
        new Thread(test3.new Consumer()).start();
        new Thread(test3.new Producer()).start();
        new Thread(test3.new Consumer()).start();
        new Thread(test3.new Producer()).start();
        new Thread(test3.new Consumer()).start();
    }
    class Producer implements Runnable {
        @Override
        public void run() {
            for (int i = 0; i < 10; i++) {
                try {
                    Thread.sleep(3000);
                } catch (Exception e) {
                    e.printStackTrace();
                }
                try {
                    blockingQueue.put(1);
                    count++;
                    System.out.println(Thread.currentThread().getName()
                            + "ç”Ÿäº§è€…ç”Ÿäº§ï¼Œç›®å‰æ€»å…±æœ‰" + count);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }
    class Consumer implements Runnable {
        @Override
        public void run() {
            for (int i = 0; i < 10; i++) {
                try {
                    Thread.sleep(3000);
                } catch (InterruptedException e1) {
                    e1.printStackTrace();
                }
                try {
                    blockingQueue.take();
                    count--;
                    System.out.println(Thread.currentThread().getName()
                            + "æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œç›®å‰æ€»å…±æœ‰" + count);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }
}
```




## ä¿¡å·é‡Semaphoreçš„å®ç°

Semaphoreï¼ˆä¿¡å·é‡ï¼‰æ˜¯ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡ï¼Œå®ƒé€šè¿‡åè°ƒå„ä¸ªçº¿ç¨‹ï¼Œä»¥ä¿è¯åˆç†çš„ä½¿ç”¨å…¬å…±èµ„æºï¼Œåœ¨æ“ä½œç³»ç»Ÿä¸­æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„é—®é¢˜ï¼Œå¯ä»¥ç”¨æ¥è§£å†³å“²å­¦å®¶å°±é¤é—®é¢˜ã€‚Javaä¸­çš„Semaphoreç»´æŠ¤äº†ä¸€ä¸ªè®¸å¯é›†ï¼Œä¸€å¼€å§‹å…ˆè®¾å®šè¿™ä¸ªè®¸å¯é›†çš„æ•°é‡ï¼Œå¯ä»¥ä½¿ç”¨acquire()æ–¹æ³•è·å¾—ä¸€ä¸ªè®¸å¯ï¼Œå½“è®¸å¯ä¸è¶³æ—¶ä¼šè¢«é˜»å¡ï¼Œrelease()æ·»åŠ ä¸€ä¸ªè®¸å¯ã€‚åœ¨ä¸‹åˆ—ä»£ç ä¸­ï¼Œè¿˜åŠ å…¥äº†å¦å¤–ä¸€ä¸ªmutexä¿¡å·é‡ï¼Œç»´æŠ¤ç”Ÿäº§è€…æ¶ˆè´¹è€…ä¹‹é—´çš„åŒæ­¥å…³ç³»ï¼Œä¿è¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„äº¤æ›¿è¿›è¡Œ

```java
import java.util.concurrent.Semaphore;
/**
 * ä½¿ç”¨semaphoreä¿¡å·é‡å®ç°
 * @author ZGJ
 * @date 2017å¹´6æœˆ29æ—¥
 */
public class Test4 {
    private static Integer count = 0;
    //åˆ›å»ºä¸‰ä¸ªä¿¡å·é‡
    final Semaphore notFull = new Semaphore(10);
    final Semaphore notEmpty = new Semaphore(0);
    final Semaphore mutex = new Semaphore(1);
    public static void main(String[] args) {
        Test4 test4 = new Test4();
        new Thread(test4.new Producer()).start();
        new Thread(test4.new Consumer()).start();
        new Thread(test4.new Producer()).start();
        new Thread(test4.new Consumer()).start();
        new Thread(test4.new Producer()).start();
        new Thread(test4.new Consumer()).start();
        new Thread(test4.new Producer()).start();
        new Thread(test4.new Consumer()).start();
    }
    class Producer implements Runnable {
        @Override
        public void run() {
            for (int i = 0; i < 10; i++) {
                try {
                    Thread.sleep(3000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                try {
                    notFull.acquire();
                    mutex.acquire();
                    count++;
                    System.out.println(Thread.currentThread().getName()
                            + "ç”Ÿäº§è€…ç”Ÿäº§ï¼Œç›®å‰æ€»å…±æœ‰" + count);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } finally {
                    mutex.release();
                    notEmpty.release();
                }
            }
        }
    }
    class Consumer implements Runnable {
        @Override
        public void run() {
            for (int i = 0; i < 10; i++) {
                try {
                    Thread.sleep(3000);
                } catch (InterruptedException e1) {
                    e1.printStackTrace();
                }
                try {
                    notEmpty.acquire();
                    mutex.acquire();
                    count--;
                    System.out.println(Thread.currentThread().getName()
                            + "æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œç›®å‰æ€»å…±æœ‰" + count);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } finally {
                    mutex.release();
                    notFull.release();
                }
            }
        }
    }
}
```

## å¯é‡å…¥é”ReentrantLockçš„å®ç°ï¼ˆä¸»ï¼‰

java.util.concurrent.lock ä¸­çš„ Lock æ¡†æ¶æ˜¯é”å®šçš„ä¸€ä¸ªæŠ½è±¡ï¼Œé€šè¿‡å¯¹lockçš„lock()æ–¹æ³•å’Œunlock()æ–¹æ³•å®ç°äº†å¯¹é”çš„æ˜¾ç¤ºæ§åˆ¶ï¼Œè€Œsynchronize()åˆ™æ˜¯å¯¹é”çš„éšæ€§æ§åˆ¶ã€‚
å¯é‡å…¥é”ï¼Œä¹Ÿå«åšé€’å½’é”ï¼ŒæŒ‡çš„æ˜¯åŒä¸€çº¿ç¨‹ å¤–å±‚å‡½æ•°è·å¾—é”ä¹‹å ï¼Œå†…å±‚é€’å½’å‡½æ•°ä»ç„¶æœ‰è·å–è¯¥é”çš„ä»£ç ï¼Œä½†ä¸å—å½±å“ï¼Œç®€å•æ¥è¯´ï¼Œè¯¥é”ç»´æŠ¤è¿™ä¸€ä¸ªä¸è·å–é”ç›¸å…³çš„è®¡æ•°å™¨ï¼Œå¦‚æœæ‹¥æœ‰é”çš„æŸä¸ªçº¿ç¨‹å†æ¬¡å¾—åˆ°é”ï¼Œé‚£ä¹ˆè·å–è®¡æ•°å™¨å°±åŠ 1ï¼Œå‡½æ•°è°ƒç”¨ç»“æŸè®¡æ•°å™¨å°±å‡1ï¼Œç„¶åé”éœ€è¦è¢«é‡Šæ”¾ä¸¤æ¬¡æ‰èƒ½è·å¾—çœŸæ­£é‡Šæ”¾ã€‚å·²ç»è·å–é”çš„çº¿ç¨‹è¿›å…¥å…¶ä»–éœ€è¦ç›¸åŒé”çš„åŒæ­¥ä»£ç å—ä¸ä¼šè¢«é˜»å¡ã€‚

```java
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
/**
 * ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼ŒReentrantLockçš„å®ç°
 * 
 * @author ZGJ
 * @date 2017å¹´6æœˆ22æ—¥
 */
public class Test2 {
    
    //æ­¤æ—¶æ˜¯ç”¨ä¸€ä¸ªcountå˜é‡æ¥ä»£æ›¿é˜Ÿåˆ—
    private static Integer count = 0;
    private static final Integer FULL = 10;
    //åˆ›å»ºä¸€ä¸ªé”å¯¹è±¡
    private Lock lock = new ReentrantLock();
    //åˆ›å»ºä¸¤ä¸ªæ¡ä»¶å˜é‡ï¼Œä¸€ä¸ªä¸ºç¼“å†²åŒºéæ»¡ï¼Œä¸€ä¸ªä¸ºç¼“å†²åŒºéç©º
    private final Condition notFull = lock.newCondition();
    private final Condition notEmpty = lock.newCondition();
    public static void main(String[] args) {
        Test2 test2 = new Test2();
        new Thread(test2.new Producer()).start();
        new Thread(test2.new Consumer()).start();
        new Thread(test2.new Producer()).start();
        new Thread(test2.new Consumer()).start();
        new Thread(test2.new Producer()).start();
        new Thread(test2.new Consumer()).start();
        new Thread(test2.new Producer()).start();
        new Thread(test2.new Consumer()).start();
    }
    class Producer implements Runnable {
        @Override
        public void run() {
            for (int i = 0; i < 10; i++) {
                try {
                    Thread.sleep(3000);
                } catch (Exception e) {
                    e.printStackTrace();
                }
                //è·å–é”
                lock.lock();
                try {
                    while (count == FULL) {
                        try {
                            
                            //é˜Ÿåˆ—æ»¡äº†ï¼Œé‚£ä¹ˆä¸æ»¡çš„conditionå°±é˜»å¡
                            notFull.await();
                        } catch (InterruptedException e) {
                            e.printStackTrace();
                        }
                    }
                    count++;
                    System.out.println(Thread.currentThread().getName()
                            + "ç”Ÿäº§è€…ç”Ÿäº§ï¼Œç›®å‰æ€»å…±æœ‰" + count);
                    //å”¤é†’æ¶ˆè´¹è€…
                    notEmpty.signal();
                } finally {
                    //é‡Šæ”¾é”
                    lock.unlock();
                }
            }
        }
    }
    class Consumer implements Runnable {
        @Override
        public void run() {
            for (int i = 0; i < 10; i++) {
                try {
                    Thread.sleep(3000);
                } catch (InterruptedException e1) {
                    e1.printStackTrace();
                }
                lock.lock();
                try {
                    while (count == 0) {
                        try {
                            //é˜Ÿåˆ—ç©ºäº†ï¼Œé‚£ä¹ˆä¸ç©ºçš„conditionå°±é˜»å¡
                            notEmpty.await();
                        } catch (Exception e) {
                            e.printStackTrace();
                        }
                    }
                    count--;
                    System.out.println(Thread.currentThread().getName()
                            + "æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œç›®å‰æ€»å…±æœ‰" + count);
                    notFull.signal();
                } finally {
                    lock.unlock();
                }
            }
        }
    }
}
```











# é˜»å¡é˜Ÿåˆ—å®ç°

```java


class ArrayBlockingQueue{
  int size = 10;
  Deque queue = new ArrayDeque();
  ReetrantLock lock = new ReetrantLock();
  Condition notEmpty = lock.newCondition(), notFull = lock.newCondition();
    
  //ä¸ç©ºå­˜æ¶ˆè´¹è€…
  //ä¸æ»¡å­˜ç”Ÿäº§è€…
    
  Object poll() {
    lock.lock();
    try {
      while (queue.isEmpty()) {
          //å½“é˜Ÿåˆ—ä¸ºç©ºäº†ï¼Œé‚£ä¹ˆä¸ç©ºçš„conditionå°±é˜»å¡æ¶ˆè´¹è€…
        notEmpty.await();
      }
      Object res = queue.pollFirst();
      //é˜Ÿåˆ—é‡Œé¢æœ‰æ•°æ®äº†ï¼Œå”¤é†’ä¸æ»¡conditionï¼Œç”Ÿäº§è€…
      notFull.signal();
      return res;
    } catch (Exception e) {
      //
    } finally {
      lock.unlock();
    }
  }
  void offer(Object object) {
    lock.lock();
    try {
      while (queue.size() == size) {
          //å½“é˜Ÿåˆ—æ»¡äº†ï¼Œé˜»å¡ä¸æ»¡conditionï¼Œé˜»å¡x'z
          
        notFull.await();
      }
      queue.offer(object);
        
        //é˜Ÿåˆ—æ¶ˆè´¹å®Œå…ƒç´ äº†
        //å”¤é†’ä¸ç©ºcondition
      notEmpty.signal();
      return;
    } catch (Exception e) {
      //
    } finally {
      lock.unlock();
    }
  }
}
```







# æ— é”å¹¶å‘é˜Ÿåˆ—

åŸºäºCAS



```java
import java.util.concurrent.atomic.AtomicInteger;
 
public class ConcurrentLoopQueue {
    private int capacity;
    private AtomicInteger head;
    private AtomicInteger tail;
    private volatile Integer[] array;
 
 
    public ConcurrentLoopQueue(int capacity) {
        this.capacity = capacity;
        array = new Integer[capacity];
        head = new AtomicInteger(0);
        tail = new AtomicInteger(0);
    }
 
 
    public boolean enqueue(Integer ele){
        boolean flag = true;
        int preTail = 0;
        int nextTail = 0;
        while(flag){
            preTail = tail.get();
            if((preTail + 1) % capacity == head.get()){ //é˜Ÿåˆ—å·²æ»¡
                return false;
            }
 
            nextTail = (preTail + 1) % capacity;
            if(tail.compareAndSet(preTail,nextTail)){
                array[preTail] = ele;
                return true;
            }
        }
        return false;
    }
 
    public Integer dequeue(){
        int preHead = 0;
        int nextHead = 0;
        boolean flag = true;
        while(flag){
            preHead = head.get();
            if(preHead == tail.get()){ // é˜Ÿåˆ—ç©º
                return null;
            }
            nextHead = (preHead + 1) % capacity;
            if(head.compareAndSet(preHead,nextHead)){
                return array[preHead];
            }
        }
        return null;
    }
}
```







> éœ€è¦æ³¨æ„çš„æ˜¯:
>
> - 1.ç¯å½¢é˜Ÿåˆ—çš„æ˜¯å¦å·²æ»¡çš„åˆ¤æ–­æ¡ä»¶ï¼›
>
>   æ™®é€šç¯å½¢é˜Ÿåˆ—çš„åˆ¤æ»¡æ¡ä»¶æ˜¯ï¼štail == capacity;ä½†æ˜¯ç¯å½¢é˜Ÿåˆ—æ˜¯æŠŠçº¿å‹çš„æ•°ç»„æ°æˆäº†ç¯çŠ¶ï¼Œåˆ¤æ»¡æ¡ä»¶å°±å˜æˆäº†(tail + 1)%capacity==headã€‚
>
> 
>
> - 2.è™½ç„¶ç¨‹åºä¸­æœ‰ä¸¤ç±»ä¸´ç•Œèµ„æºï¼Œä½†æ˜¯åœ¨å¹¶å‘æ“ä½œä¸­ï¼Œå…¶å®æœ€ç›´æ¥çš„ä¸´ç•Œèµ„æºæ˜¯tailå’Œheadï¼Œä¸æ˜¯å­˜æ”¾æ•°æ®çš„æ•°ç»„ã€‚å› ä¸ºæ¯ä¸ªçº¿ç¨‹æ˜¯å…ˆè·å¾—æ•°ç»„ä¸‹æ ‡(tailæˆ–è€…head)ï¼Œç„¶åå†æ“ä½œå¯¹åº”çš„æ•°ç»„ä½ç½®ï¼Œåªè¦èƒ½ä¿è¯tailæˆ–è€…headçš„çº¿ç¨‹å®‰å…¨ï¼ŒåŸºæœ¬ä¸Šæ¥ä¸‹æ¥çš„æ“ä½œä¹Ÿå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„äº†ã€‚





# æ‰‹å†™HashMap

## mapæ¥å£

```java
public interface Map<K,V> {
    V put(K k, V v);

    V get(K k);

    int size();

    V remove(K k);

    boolean isEmpty();

    void clear();
}
```

## Nodeç»“ç‚¹

```java
class Node<K,V> {
    K k;
    V v;
    Node<K,V> next;
    public Node(K k,V v, Node<K,V> next) {
        this.k = k;
        this.v = v;
        this.next = next;
    }
}
```



## MyHashMap

```java
public class MyHashMap<K,V> implements Map<K,V> {


    //é»˜è®¤åˆå§‹åŒ–å®¹é‡
    final static int DEFAULT_CAPACITY = 16;
    //é»˜è®¤åŠ è½½å› å­
    final static float DEFAULT_LOAD_FACTOR = 0.75f;

    //å®¹é‡
    int capacity;
    //åŠ è½½å› å­
    float loadFactor;

    //æ•°ç»„
    Node<K,V>[] table;

    //å“ˆå¸Œè¡¨çš„æ‰€æœ‰ç»“ç‚¹
    int size;

    public MyHashMap(int capacity, float loadFactor) {
        this.capacity = capacity;
        this.loadFactor = loadFactor;
    }


    public MyHashMap() {
        this(DEFAULT_CAPACITY, DEFAULT_LOAD_FACTOR);
    }


    @Override
    public V put(K k, V v) {


        int index = k.hashCode() % table.length;
        Node<K,V> current = table[index];

        if(current == null) {
            //å¦‚æœtable[index] ä¸ºnull,ç›´æ¥èµ‹å€¼
            table[index] = new Node<K,V>(k,v,null);
            size++;
        }else {
            //éå†é“¾è¡¨
            while (current != null) {
                if(current.k == k) {
                   V oldValue = current.v;
                   //æ–°valueè¦†ç›–æ—§value
                   current.v = v;
                   return oldValue;
                }
                current = current.next;
            }

            //å¦‚æœé“¾è¡¨æ²¡æœ‰ç›¸åŒçš„keyå°±å¤´æ’
            //å³è¾¹çš„table[index] æ˜¯æ—§çš„ç¬¬ä¸€ä¸ªç»“ç‚¹ï¼Œå½“å‰ç»“ç‚¹æ’å…¥è¿™ä¸ªæ—§çš„ç»“ç‚¹å‰é¢
            table[index] = new Node<K,V>(k,v,table[index]);
            size++;
            return null;
         }
        return null;
    }

    @Override
    public V get(K k) {
        int index = k.hashCode() % table.length;

        Node<K,V> current = table[index];

       while (current != null) {
           if(current.k == k) {
               return current.v;
           }
           current = current.next;
       }
        return null;
    }

    @Override
    public int size() {
        return size;
    }

    @Override
    public V remove(K k) {
        int index = k.hashCode() % table.length;
        Node<K,V> current = table[index];
         //å¦‚æœç›´æ¥åŒ¹é…ç¬¬ä¸€ä¸ªç»“ç‚¹
        if(current.k == k && current.next == null) {
            table[index] = null;
            size--;
            return current.v;
        }

        //åœ¨é“¾è¡¨ä¸­åˆ é™¤ç»“ç‚¹
        while (current.next != null) {
            if(current.next.k == k) {
                V oldValue = current.next.v;
                current.next = current.next.next;
                size--;
                return oldValue;
            }
            current = current.next;
        }
        return null;
    }

    @Override
    public boolean isEmpty() {
        return size == 0;
    }

    @Override
    public void clear() {

    }
}
```





















# LRU

å“ˆå¸Œè¡¨åŠ ä¸ŠåŒå‘é“¾è¡¨



```java
class LRUCache {ã€
    /*
    ä¸€ä¸ªNodeç»“ç‚¹ç±»
    ä¸€ä¸ªåŒå‘é“¾è¡¨ é“¾è¡¨ç»“ç‚¹ä¸ºNodeç»“ç‚¹
    ä¸€ä¸ªhashmap keyä¸ºint valueä¸ºNode
    ä¸€ä¸ªcapacoty ä¸€ä¸ªsize
    ä¸€ä¸ªput ä¸€ä¸ªget 
    ä¸€ä¸ªaddToHead   ï¼ˆçœŸå®æ“ä½œï¼ŒæŠŠç»“ç‚¹æ·»åŠ è‡³é“¾è¡¨å¤´éƒ¨ï¼Œä¸€èˆ¬ç”¨äºæ–°æ’å…¥çš„ç»“ç‚¹ï¼‰
    ä¸€ä¸ªRemoveNode ï¼ˆç›¸å½“äºè¾…åŠ©æ“ä½œï¼Œåˆ é™¤èŠ‚ç‚¹ï¼‰
    ä¸€æ ¼MoveToHead  ï¼ˆæŠŠé“¾è¡¨ç»“ç‚¹ä»åŸæ¥çš„ä½ç½®ç§»åŠ¨è‡³é“¾è¡¨å¤´éƒ¨ï¼‰
    ä¸€ä¸ªRemoveTail  ï¼ˆæŠŠè™šæ‹Ÿå°¾ç»“ç‚¹å‰çš„ç»“ç‚¹åˆ é™¤å¹¶è¿”å›ï¼Œä¸ºä»€ä¹ˆè¦è¿”å›ï¼Ÿè¿˜å¾—æ ¹æ®è¿”å›çš„ç»“ç‚¹åˆ é™¤åœ¨HashMapå¯¹åº”çš„ç»“ç‚¹ï¼‰
    
    */

     class Node {
         int key;
         int value;
         Node pre;
         Node next;
         public Node() {};
         public Node(int key, int value) {
             this.key = key;
             this.value = value;
         }
     }

     public Map<Integer, Node> map = new HashMap<Integer, Node>();

     public int  capacity;

     int size;
     public Node head, tail;

    public LRUCache(int capacity) {
        this.size = 0;
        this.capacity = capacity;
        head = new Node();
        tail = new Node();
        head.next = tail;
        tail.pre = head;
    }
    
    public int get(int key) {

        Node node = map.get(key);
        if(node == null) return -1;

        MoveToHead(node);
        return node.value;

    }
    
    public void put(int key, int value) {
        Node node = map.get(key);
        if(node == null) {
            Node newNode =  new Node(key, value);
            map.put(key, newNode);
            addToHead(newNode);
            size++;

            if(size > capacity) {
            Node  tailpre   = RemoveTail();
            map.remove(tailpre.key);    
            size--;
            }


        } else {
            node.value = value;
            MoveToHead(node);

        }

    }

    public void addToHead(Node node) {
        node.pre = head;
        node.next = head.next;
        node.next.pre = node;
        head.next = node;

    }

    public void RemoveNode(Node node) {
        node.pre.next = node.next;
        node.next.pre = node.pre;
    }


    public void MoveToHead(Node node) {
        RemoveNode(node);
        addToHead(node);
    }

    public Node RemoveTail() {
         Node t =  tail.pre;
        RemoveNode(tail.pre);
        return t;
    }
    
    







}

/**
 * Your LRUCache object will be instantiated and called as such:
 * LRUCache obj = new LRUCache(capacity);
 * int param_1 = obj.get(key);
 * obj.put(key,value);
 */
```



## ä¼˜åŒ–



ä¸Šé¢çš„LRUç®—æ³•è¿˜æœ‰ä¸€äº›ä¸è¶³ï¼šå½“çƒ­ç‚¹æ•°æ®è¾ƒå¤šæ—¶ï¼Œæœ‰è¾ƒé«˜çš„å‘½ä¸­ç‡ï¼Œä½†æ˜¯å¦‚æœæœ‰å¶å‘æ€§çš„æ‰¹é‡æ“ä½œï¼Œä¼šä½¿å¾—çƒ­ç‚¹æ•°æ®è¢«éçƒ­ç‚¹æ•°æ®æŒ¤å‡ºå®¹å™¨ã€‚

é‚£å°±å‡ºç°äº†LRU-Kï¼Œå®ƒæ˜¯å¯¹ä¸Šé¢LRUç®—æ³•çš„æ”¹è¿›ï¼Œå¯ä»¥è¯´ä¸Šé¢çš„åŸºç¡€LRUæ˜¯LRU-1ï¼ŒLRU-Kæ˜¯å°†åŸå…ˆè¿›å…¥ç¼“å­˜é˜Ÿåˆ—çš„è¯„åˆ¤æ ‡å‡†ä»è®¿é—®ä¸€æ¬¡æ”¹ä¸ºè®¿é—®Kæ¬¡ã€‚

LRU-Kç®—æ³•æœ‰ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯ç¼“å­˜é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯æ•°æ®è®¿é—®å†å²é˜Ÿåˆ—ã€‚å½“è®¿é—®ä¸€ä¸ªæ•°æ®æ—¶ï¼Œé¦–å…ˆå…ˆåœ¨è®¿é—®å†å²é˜Ÿåˆ—ä¸­ç´¯åŠ è®¿é—®æ¬¡æ•°ï¼Œå½“å†å²è®¿é—®è®°å½•è¶…è¿‡Kæ¬¡åï¼Œæ‰å°†æ•°æ®ç¼“å­˜è‡³ç¼“å­˜é˜Ÿåˆ—ï¼Œä»è€Œé¿å…ç¼“å­˜é˜Ÿåˆ—è¢«æ±¡æŸ“ã€‚åŒæ—¶è®¿é—®å†å²é˜Ÿåˆ—ä¸­çš„æ•°æ®å¯ä»¥æŒ‰ç…§LRUçš„è§„åˆ™è¿›è¡Œæ·˜æ±°ã€‚



![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../images/%E7%BA%BF%E7%A8%8B%E7%BB%8F%E5%85%B8%E9%97%AE%E9%A2%98/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBA5rKZ5rupZGXmtYHmspk=,size_19,color_FFFFFF,t_70,g_se,x_16.png)







```java
// ç›´æ¥ç»§æ‰¿æˆ‘ä»¬å‰é¢å†™å¥½çš„LRUCache
public class LRUKCache extends LRUCache {
    
    private int k; // è¿›å…¥ç¼“å­˜é˜Ÿåˆ—çš„è¯„åˆ¤æ ‡å‡†
    private LRUCache historyList; // è®¿é—®æ•°æ®å†å²è®°å½•

    public LRUKCache(int cacheSize, int historyCapacity, int k) {
        super(cacheSize);
        this.k = k;
        this.historyList = new LRUCache(historyCapacity);
    }

    @Override
    public Integer get(Integer key) {

        // è®°å½•æ•°æ®è®¿é—®æ¬¡æ•°
        Integer historyCount = historyList.get(key);
        historyCount = historyCount == null ? 0 : historyCount;
        historyList.put(key, ++historyCount);

        return super.get(key);
    }

    @Override
    public Integer put(Integer key, Integer value) {

        if (value == null) {
            return null;
        }
        
        // å¦‚æœå·²ç»åœ¨ç¼“å­˜é‡Œåˆ™ç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„æ•°æ®
        if (super.get(key) != null) {
            return super.put(key, value);;
        }

        // å¦‚æœæ•°æ®å†å²è®¿é—®æ¬¡æ•°è¾¾åˆ°ä¸Šé™ï¼Œåˆ™åŠ å…¥ç¼“å­˜
        Integer historyCount = historyList.get(key);
        historyCount = historyCount == null ? 0 : historyCount;
        if (historyCount >= k) {
            // ç§»é™¤å†å²è®¿é—®è®°å½•
            historyList.remove(key);
            return super.put(key, value);
        }
    }
}

```









## å¹¶å‘ç‰ˆ





![img](../../images/%E7%BA%BF%E7%A8%8B%E7%BB%8F%E5%85%B8%E9%97%AE%E9%A2%98/EE7D0CB04969F749DE91D51E0F4B670E.jpg)



åŠ é”æŠŠ 





# LFU

**è¡°å‡**





# KMP

å­—ç¬¦ä¸²æ¨¡å¼åŒ¹é…

![image-20220424165935010](../images/%E5%88%86%E7%B1%BB%E9%A2%98%E7%9B%AE/image-20220424165935010.png)



## **è§£æ³•**ä¸€



### æ±‚nextæ•°ç»„



```java
public int[] getNext(String s){
    int i = 0;
    int j = -1;
    int n = s.length();
    
    int[] next = new int[n];
    next[0] = -1;

    while(i < n - 1){
        if(j == -1 || s.charAt(i) == s.charAt(j)){
            i += 1;
            j += 1;
            next[i] = j;
        }else{
            j = next[j];
        }
    }
    return next;
}
```



```java
class Solution {
     //kmpæ±‚nextæ•°ç»„
     public int[] getNext(String s) {
         int i = 0;
         int j = -1;
         
         int n = s.length();

         int[] next = new int[s.length()];
         next[0] = -1;
         while(i < n - 1) {
             if(j == -1 || s.charAt(i) == s.charAt(j)) {
                 i++;
                 j++;
                 next[i] = j;
             }else{
                 j = next[j];
             }
         }
         return next;

     }
   
    public boolean repeatedSubstringPattern(String s) {
           if(s.length() == 0) return false;
           int n = s.length();
           int[] next = getNext(s);
           int len = next[s.length() - 1] + 1;
           
           if(len == 0 || s.charAt(n - 1) != s.charAt(n - 1 - len)) return false;

            return  n % (n - len) == 0;

    }


}
```







## è§£æ³•äºŒ

```java
class Solution{
    public boolean repeatedSubstrinngPattern(String s){
        //åˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼Œç”±ä¸¤ä¸ªå­—ä¸²è¿æ¥
    String str = s+s;
    return str.subString(1,str.length()-1).contains(s);//å»æ‰å¤´å’Œå°¾ï¼Œå†æ¥çœ‹æ˜¯å¦æœ‰é‡å¤çš„ï¼Œä¸‹é¢ç”»ä¸ªå›¾
    // s=abab  s+s=abababab
    //å»æ‰é¦–å°¾å str=bababa ,é‚£ä¹ˆä¸€å®šèƒ½æ‰¾åˆ°å’Œsä¸€æ ·çš„ï¼Œé‚£ä¹ˆä¹Ÿå°±ä»£è¡¨æœ‰é‡å¤çš„å­—ä¸²äº†
}
}


class Solution {
public  boolean repeatedSubstringPattern(String s) {
    int len = s.length();
        if (len == 0)  return false;  
        int[] next = getNext(s.toCharArray());
        if (next[len - 1] != 0 && len % (len - (next[len - 1] )) == 0) return true;
        return false;
    }

    public int[] getNext(char[] sArr){
        int[] next = new int[sArr.length];
        int j = 0; //j:å‰ç¼€æœ«å°¾
        for(int i = 1; i < next.length; i++){ //i:åç¼€æœ«å°¾
            while(j > 0 && sArr[i] != sArr[j])  j = next[j - 1];
            if(sArr[i] == sArr[j])  j++;
            next[i] = j;
        }
        return next;   

    }
}
```







# æ•°æ®ç»“æ„

## æ’åº

æ¡¶æ’åº è®¡æ•°æ’åº åŸºç¡€æ’åº 

å¿«æ’ å½’å¹¶ å †æ’åº

è§[Category: æ•°æ®ç»“æ„ä¸ç®—æ³• | D_W? (gitee.io)](https://dgw_521.gitee.io/categories/æ•°æ®ç»“æ„ä¸ç®—æ³•/)



## å¸¸ç”¨topké—®é¢˜

è§[Category: æ•°æ®ç»“æ„ä¸ç®—æ³• | D_W? (gitee.io)](https://dgw_521.gitee.io/categories/æ•°æ®ç»“æ„ä¸ç®—æ³•/)



# æµ·é‡æ•°æ®é—®é¢˜

è§[Category: æ•°æ®ç»“æ„ä¸ç®—æ³• | D_W? (gitee.io)](https://dgw_521.gitee.io/categories/æ•°æ®ç»“æ„ä¸ç®—æ³•/)



ç›´æ¥çœ‹è¿™ä¸ªå§ï¼šhttps://doocs.github.io/advanced-java/#/docs/big-data/find-common-urls



## Arrays.sort()åŸç†



## æµ·é‡æ•°æ®æ’åºé—®é¢˜

> ### å¤šè·¯å½’å¹¶
>
> æµ·é‡æ•°æ®ä¸èƒ½ä¸€æ¬¡æ€§è¯»å…¥å†…å­˜ï¼Œåœ¨å¯¹æµ·é‡æ•°æ®è¿›è¡Œæ’åºæ—¶ï¼Œé¦–å…ˆéœ€è¦å°†æµ·é‡æ•°æ®æ‹†åˆ†åˆ°å¤šå°æœºå™¨æˆ–è€…å¤šä¸ªæ–‡ä»¶ï¼Œè¿™äº›æœºå™¨æˆ–æ–‡ä»¶ç§°ä¸ºæ‹†åˆ†èŠ‚ç‚¹ï¼›ç„¶ååœ¨æ¯ä¸ªæ‹†åˆ†èŠ‚ç‚¹ä¸Šå°†æ•°æ®å…¨éƒ¨è¯»å…¥å†…å­˜å¹¶ä½¿ç”¨å¿«é€Ÿæ’åºç­‰æ–¹æ³•è¿›è¡Œæ’åºï¼›æœ€ååœ¨åˆå¹¶èŠ‚ç‚¹ä½¿ç”¨å¤šè·¯å½’å¹¶æ–¹æ³•å°†æ‰€æœ‰æ‹†åˆ†èŠ‚ç‚¹çš„éƒ¨åˆ†æ’åºç»“æœæ•´åˆæˆæœ€ç»ˆçš„æ’åºç»“æœã€‚å¤–éƒ¨æ’åºä¹Ÿå¯ä»¥è¢«ç§°ä¸ºå¤–éƒ¨å½’å¹¶æ’åºã€‚
>
>
> å¦‚æœä¸è¿›è¡Œé¢å¤–å¤„ç†ï¼Œåˆå¹¶èŠ‚ç‚¹ä»ç„¶æ— æ³•å°†æ‰€æœ‰æ•°æ®è¯»å…¥å†…å­˜ä¸­ã€‚å¯ä»¥ä½¿ç”¨å°é¡¶å †æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š
>
> å‡è®¾æœ‰ k ä¸ªæ‹†åˆ†èŠ‚ç‚¹ï¼Œä»è¿™ k ä¸ªæ‹†åˆ†èŠ‚ç‚¹åˆ†åˆ«è¯»å–ä¸€ä¸ªæœ€å°çš„æ•°æ®åˆ°å°é¡¶å †ä¸­ã€‚
> å°†å †é¡¶æ•°æ®ç§»å‡ºå †å¹¶å†™å…¥åˆå¹¶èŠ‚ç‚¹çš„æœ€ç»ˆç»“æœæ–‡ä»¶ä¸­ã€‚
> ç¡®å®šåˆšæ‰ä»å †ä¸­ç§»é™¤çš„æ•°æ®å±äºå“ªä¸ªæ‹†åˆ†èŠ‚ç‚¹ï¼Œå¹¶ä»è¯¥æ‹†åˆ†èŠ‚ç‚¹å†è¯»å…¥ä¸€ä¸ªæ•°æ®ã€‚
>
> æµ·é‡æ•°æ®æ’åºæœ€åå½’å¹¶å¾—åœ¨å†…å­˜ç»´æŠ¤ä¸€ä¸ªå°é¡¶å †
>
> 
>
> ### bitmap
>
> å…ˆå»é‡å†ç”¨Bitmqp





**å¤§æ•°æ®å°å†…å­˜[æ’åº](https://www.nowcoder.com/jump/super-jump/word?word=æ’åº)é—®é¢˜**

- æ•°æ®åº“[æ’åº](https://www.nowcoder.com/jump/super-jump/word?word=æ’åº)ï¼ˆå¯¹æ•°æ®åº“è®¾å¤‡è¦æ±‚è¾ƒé«˜ï¼‰
- åˆ†æ²»æ³•ï¼ˆå¸¸è§æ€è·¯ï¼‰
- ä½å›¾æ³•ï¼ˆBitmapï¼‰



> ## 1. æ•°æ®åº“[æ’åº](https://www.nowcoder.com/jump/super-jump/word?word=æ’åº)
>
> å°†å­˜å‚¨ç€ 100 äº¿æ•°æ®çš„æ–‡æœ¬æ–‡ä»¶ä¸€æ¡ä¸€æ¡å¯¼å…¥åˆ°æ•°æ®åº“ä¸­ï¼Œç„¶åæ ¹æ®æŸä¸ªå­—æ®µå»ºç«‹ç´¢å¼•ï¼Œæ•°æ®åº“è¿›è¡Œç´¢å¼•[æ’åº](https://www.nowcoder.com/jump/super-jump/word?word=æ’åº)æ“ä½œåæˆ‘ä»¬å°±å¯ä»¥ä¾æ¬¡æå–å‡ºæ•°æ®è¿½åŠ åˆ°ç»“æœé›†ä¸­ã€‚
>
> è¿™ç§æ–¹æ³•çš„ç‰¹ç‚¹å°±æ˜¯æ“ä½œç®€å•ï¼Œ è¿ç®—é€Ÿåº¦è¾ƒæ…¢ï¼Œå¯¹æ•°æ®åº“è®¾å¤‡è¦æ±‚è¾ƒé«˜
>
> ## 2. åˆ†æ²»æ³•
>
> å‡è®¾ 100 äº¿ä¸ªæ•°æ®éƒ½æ˜¯ int ç±»å‹çš„æ•°å­—
>
> 1 ä¸ª int ç±»å‹å  4 ä¸ªå­—èŠ‚ï¼ˆbyteï¼ŒBï¼‰
>
> 1 B = 8 ä½ï¼ˆbitï¼‰
>
> 1024 Bï¼ˆ1024 B = 1KBï¼‰ = 8 * 1024 bit
>
> 1024 * 1024 KBï¼ˆ1024KB = 1MBï¼‰= 1024 * 8 * 1024 bit
>
> 100 äº¿ int å‹æ•°å­—å°±æ˜¯ 100 äº¿ x 4B = 400 äº¿ B = 38146.97265625 MB çº¦ç­‰äº 37.25GB
>
> 100 äº¿ä¸ª int å‹æ•°å­—å¤§æ¦‚å  37 ä¸ª Gï¼Œ2G å†…å­˜æ˜¾ç„¶ä¸€æ¬¡æ€§æ˜¯è£…ä¸ä¸‹çš„ã€‚
>
> æœ€å¸¸è§çš„æ€è·¯ï¼Œæ‹†åˆ†æˆä¸€ä¸ªä¸€ä¸ªçš„å°æ–‡ä»¶æ¥å¤„ç†å‘—ï¼Œæœ€ç»ˆå†åˆå¹¶æˆä¸€ä¸ªæ’å¥½åºçš„å¤§æ–‡ä»¶ã€‚
>
> å…¸å‹çš„åˆ†æ²»æ³•
>
> 1ï¼‰æŠŠè¿™ä¸ª 37 GB çš„å¤§æ–‡ä»¶ï¼Œç”¨å“ˆå¸Œæˆ–è€…ç›´æ¥å¹³å‡åˆ†æˆè‹¥ä¸ªå°æ–‡ä»¶ï¼ˆæ¯”å¦‚ 1000 ä¸ªï¼Œæ¯ä¸ªå°æ–‡ä»¶å¹³å‡ 38 MB å·¦å³ï¼‰
>
> 2ï¼‰æ‹†åˆ†å®Œäº†ä¹‹åï¼Œå¾—åˆ° 1000 ä¸ª 30 å¤š MB çš„å°æ–‡ä»¶ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ”¾è¿›å†…å­˜é‡Œ[æ’åº](https://www.nowcoder.com/jump/super-jump/word?word=æ’åº)äº†ï¼Œå¯ä»¥ç”¨å¿«é€Ÿ[æ’åº](https://www.nowcoder.com/jump/super-jump/word?word=æ’åº)ï¼Œå½’å¹¶[æ’åº](https://www.nowcoder.com/jump/super-jump/word?word=æ’åº)ï¼Œå †[æ’åº](https://www.nowcoder.com/jump/super-jump/word?word=æ’åº)ç­‰ç­‰
>
> 3ï¼‰1000 ä¸ªå°æ–‡ä»¶å†…éƒ¨æ’å¥½åºä¹‹åï¼Œå°±è¦æŠŠè¿™äº›å†…éƒ¨æœ‰åºçš„å°æ–‡ä»¶ï¼Œåˆå¹¶æˆä¸€ä¸ªå¤§çš„æ–‡ä»¶ï¼Œå¯ä»¥ç”¨å †[æ’åº](https://www.nowcoder.com/jump/super-jump/word?word=æ’åº)æ¥åš 1000 è·¯åˆå¹¶çš„æ“ä½œï¼ˆå‡è®¾æ˜¯ä»å°åˆ°å¤§[æ’åº](https://www.nowcoder.com/jump/super-jump/word?word=æ’åº)ï¼Œç”¨å°é¡¶å †ï¼‰ï¼š
>
> - é¦–å…ˆéå† 1000 ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶é‡Œé¢å–ç¬¬ä¸€ä¸ªæ•°å­—ï¼Œç»„æˆ `(æ•°å­—, æ–‡ä»¶å·)` è¿™æ ·çš„ç»„åˆåŠ å…¥åˆ°å †é‡Œï¼Œéå†å®Œåå †é‡Œæœ‰ 1000 ä¸ª `(æ•°å­—ï¼Œæ–‡ä»¶å·)` è¿™æ ·çš„å…ƒç´ 
> - ç„¶åä¸æ–­ä»å †é¡¶ pop å…ƒç´ è¿½åŠ åˆ°ç»“æœé›†ï¼Œæ¯ pop ä¸€ä¸ªå…ƒç´ ï¼Œå°±æ ¹æ®å®ƒçš„æ–‡ä»¶å·å»å¯¹åº”çš„æ–‡ä»¶é‡Œï¼Œè¡¥è™«ä¸€ä¸ªå…ƒç´ è¿›å…¥å †ä¸­ï¼Œç›´åˆ°é‚£ä¸ªæ–‡ä»¶ä¸­çš„å…ƒç´ è¢«æ‹¿å®Œ
> - æŒ‰ç…§ä¸Šé¢çš„æ“ä½œï¼Œç›´åˆ°å †è¢«å–ç©ºäº†ï¼Œæ­¤æ—¶æœ€ç»ˆç»“æœæ–‡ä»¶é‡Œçš„å…¨éƒ¨æ•°å­—å°±æ˜¯æœ‰åºçš„äº†
>
> ## 3. ä½å›¾æ³•ï¼ˆBitmapï¼‰
>
> ä½å›¾æ³•çš„åŸºæœ¬æ€æƒ³å°±æ˜¯åˆ©ç”¨ä¸€ä½ï¼ˆbitï¼‰ä»£è¡¨ä¸€ä¸ªæ•°å­—ï¼Œä¾‹å¦‚ç¬¬ 3 ä½ä¸Šä¸º 1ï¼Œåˆ™è¯´æ˜ 3 è¿™ä¸ªæ•°å­—å‡ºç°è¿‡ï¼Œè‹¥ä¸º0ï¼Œåˆ™è¯´æ˜ 3 è¿™ä¸ªæ•°å­—æ²¡æœ‰å‡ºç°è¿‡ã€‚å¾ˆç®€å•~
>
> ä¸Šé¢åˆ†æè¿‡ï¼Œ1M = 8388608 bitï¼ˆ800 å¤šä¸‡ï¼‰
>
> ä¹Ÿå°±æ˜¯è¯´ï¼Œ**é€šè¿‡ä½å›¾æ³•ï¼Œåªéœ€è¦ 1M çš„ç©ºé—´ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¤„ç† 800 å¤šä¸‡çº§åˆ«çš„æ•°æ®**
>
> Java ä¸­æ²¡æœ‰ bit è¿™æ ·çš„åŸºæœ¬æ•°æ®ç±»å‹ï¼Œæœ€å°æ•°æ®ç±»å‹æ˜¯ `byte`ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ **byte æ•°ç»„**æ¥å®ç°è¿™ä¸ªä½å›¾æ³•
>
> byte æ•°ç»„ä¸Šçš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ byte ç±»å‹ï¼Œä¸€ä¸ª byte ç­‰äº 8 ä¸ª bitï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ 10 è¿›åˆ¶çš„ byte ç”¨äºŒè¿›åˆ¶çš„ bit æ¥è¡¨ç¤ºï¼Œå¦‚ä¸‹å›¾ï¼š
>
> ![img](../../images/%E7%BA%BF%E7%A8%8B%E7%BB%8F%E5%85%B8%E9%97%AE%E9%A2%98/20220320161702.png)
>
> è¿™æ ·ï¼Œbyte æ•°ç»„ä¸­çš„ä¸€ä¸ªå…ƒç´ å°±èƒ½è¡¨ç¤º 8 ä¸ªæ•°å­—æ˜¯å¦å‡ºç°è¿‡ï¼Œæ¯”å¦‚ byte[0] å¯ä»¥è¡¨ç¤º 0 ~ 7 æ˜¯å¦å‡ºç°è¿‡ï¼Œbyte[1] å¯ä»¥è¡¨ç¤º 8 ~ 15 æ˜¯å¦å‡ºç°è¿‡.....
>
> å…¨éƒ¨å¤„ç†å®Œä¹‹åï¼Œæˆ‘ä»¬**ä»å‰å¾€åéå†ä¸€é byte æ•°ç»„**å°±èƒ½è·å–åˆ°æœ‰åºæ•°æ®äº†ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(N)
>
> 
>
> java.util å°è£…äº† `BitSet` è¿™æ ·ä¸€ä¸ªç±»ï¼Œæ˜¯ä½å›¾æ³•çš„å…¸å‹å®ç°
>
> ![img](../../images/%E7%BA%BF%E7%A8%8B%E7%BB%8F%E5%85%B8%E9%97%AE%E9%A2%98/20220320162935.png)
>
> åº•å±‚ç”¨çš„ long æ•°ç»„ï¼Œä¸€ä¸ª long å‹æ•°æ®å  8 ä¸ªå­—èŠ‚ï¼ˆ64 ä½ï¼Œä¹Ÿå°±æ˜¯è¯´ long æ•°ç»„ä¸­çš„ä¸€ä¸ªå…ƒç´ å°±å¯ä»¥è¡¨ç¤º 64 ä¸ªæ•°å­—å¦å‡ºç°è¿‡ï¼‰ï¼Œå æ¯”ä¸åªå  1 ä¸ªå­—èŠ‚çš„ byteï¼ˆ8 ä½ï¼‰ æ¥è¯´ï¼Œèƒ½å­˜å‚¨çš„æ•°æ®æ›´å¤šäº†
>
> ```
> BitSet bitSet = ``new` `BitSet();``bitSet.set(``0``, ``2``, ``true``);
> ```
>
> ä¸Šé¢çš„ä»£ç çš„å«ä¹‰æ˜¯ï¼Œç¬¬ `[0,2)` ä½ä¼šè¢«è®¾ç½®æˆ 1ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªç±»ä¼šè‡ªåŠ¨åœ°ç”Ÿæˆä¸€ä¸ª long å‹çš„å…ƒç´ ï¼ŒäºŒè¿›åˆ¶è¡¨ç¤ºæ˜¯ `.....(çœç•¥ 60 ä¸ª 0) 0011`ï¼Œåè¿›åˆ¶è¡¨ç¤ºå°±æ˜¯ 3
>
> 
>
> ä½å›¾æ³•çš„ç¼ºç‚¹ï¼š
>
> - å¯è¯»æ€§å·®ï¼ˆä¸æ˜¯ä¸€èˆ¬çš„å·® ğŸ¤”ï¼‰
> - ä½å›¾å­˜å‚¨çš„å…ƒç´ ä¸ªæ•°è™½ç„¶æ¯”ä¸€èˆ¬åšæ³•å¤šï¼Œä½†æ˜¯å­˜å‚¨çš„å…ƒç´ å¤§å°å—é™äºå­˜å‚¨ç©ºé—´çš„å¤§å°ã€‚è¦æƒ³å®šä¹‰å­˜å‚¨ç©ºé—´å¤§å°å°±éœ€è¦å®ç°çŸ¥é“å­˜å‚¨çš„å…ƒç´ åˆ°åº•æœ‰å¤šå°‘
> - å¯¹äºæœ‰ç¬¦å·ç±»å‹çš„æ•°æ®ï¼Œéœ€è¦ç”¨ 2 ä½æ¥è¡¨ç¤ºï¼Œæ¯”å¦‚ ç¬¬ 0 ä½å’Œç¬¬ 1 ä½è¡¨ç¤º 0 è¿™ä¸ªæ•°æ®ï¼Œç¬¬ 2 ä½å’Œç¬¬ 3 ä½è¡¨ç¤º 1 è¿™ä¸ªæ•°æ®......ï¼Œè¿™ä¼šè®©ä½å›¾èƒ½å­˜å‚¨çš„å…ƒç´ ä¸ªæ•°ï¼Œå…ƒç´ å€¼å¤§å°ä¸Šé™å‡åŠ





## æµ·é‡æ•°æ®topké—®é¢˜

**ç›´æ¥çœ‹åšå®¢**https://blog.csdn.net/weixin_45394002/article/details/123575988





```java
ç¬¬äºŒç§æ–¹æ³•ä¸ºå±€éƒ¨æ·˜æ±°æ³•ï¼Œè¯¥æ–¹æ³•ä¸æ’åºæ–¹æ³•ç±»ä¼¼ï¼Œç”¨ä¸€ä¸ªå®¹å™¨ä¿å­˜å‰10000ä¸ªæ•°ï¼Œç„¶åå°†å‰©ä½™çš„æ‰€æœ‰æ•°å­—â€”â€”ä¸å®¹å™¨å†…çš„æœ€å°æ•°å­—ç›¸æ¯”ï¼Œå¦‚æœæ‰€æœ‰åç»­çš„å…ƒç´ éƒ½æ¯”å®¹å™¨å†…çš„10000ä¸ªæ•°è¿˜å°ï¼Œé‚£ä¹ˆå®¹å™¨å†…è¿™ä¸ª10000ä¸ªæ•°å°±æ˜¯æœ€å¤§10000ä¸ªæ•°ã€‚å¦‚æœæŸä¸€åç»­å…ƒç´ æ¯”å®¹å™¨å†…æœ€å°æ•°å­—å¤§ï¼Œåˆ™åˆ æ‰å®¹å™¨å†…æœ€å°å…ƒç´ ï¼Œå¹¶å°†è¯¥å…ƒç´ æ’å…¥å®¹å™¨ï¼Œæœ€åéå†å®Œè¿™1äº¿ä¸ªæ•°ï¼Œå¾—åˆ°çš„ç»“æœå®¹å™¨ä¸­ä¿å­˜çš„æ•°å³ä¸ºæœ€ç»ˆç»“æœäº†ã€‚æ­¤æ—¶çš„æ—¶é—´å¤æ‚åº¦ä¸ºOï¼ˆn+m^2ï¼‰ï¼Œå…¶ä¸­mä¸ºå®¹å™¨çš„å¤§å°ï¼Œå³10000ã€‚

ç¬¬ä¸‰ç§æ–¹æ³•æ˜¯åˆ†æ²»æ³•ï¼Œå°†1äº¿ä¸ªæ•°æ®åˆ†æˆ100ä»½ï¼Œæ¯ä»½100ä¸‡ä¸ªæ•°æ®ï¼Œæ‰¾åˆ°æ¯ä»½æ•°æ®ä¸­æœ€å¤§çš„10000ä¸ªï¼Œæœ€ååœ¨å‰©ä¸‹çš„100*10000ä¸ªæ•°æ®é‡Œé¢æ‰¾å‡ºæœ€å¤§çš„10000ä¸ªã€‚å¦‚æœ100ä¸‡æ•°æ®é€‰æ‹©è¶³å¤Ÿç†æƒ³ï¼Œé‚£ä¹ˆå¯ä»¥è¿‡æ»¤æ‰1äº¿æ•°æ®é‡Œé¢99%çš„æ•°æ®ã€‚100ä¸‡ä¸ªæ•°æ®é‡Œé¢æŸ¥æ‰¾æœ€å¤§çš„10000ä¸ªæ•°æ®çš„æ–¹æ³•å¦‚ä¸‹ï¼šç”¨å¿«é€Ÿæ’åºçš„æ–¹æ³•ï¼Œå°†æ•°æ®åˆ†ä¸º2å †ï¼Œå¦‚æœå¤§çš„é‚£å †ä¸ªæ•°Nå¤§äº10000ä¸ªï¼Œç»§ç»­å¯¹å¤§å †å¿«é€Ÿæ’åºä¸€æ¬¡åˆ†æˆ2å †ï¼Œå¦‚æœå¤§çš„é‚£å †ä¸ªæ•°Nå¤§äº10000ä¸ªï¼Œç»§ç»­å¯¹å¤§å †å¿«é€Ÿæ’åºä¸€æ¬¡åˆ†æˆ2å †ï¼Œå¦‚æœå¤§å †ä¸ªæ•°Nå°äº10000ä¸ªï¼Œå°±åœ¨å°çš„é‚£å †é‡Œé¢å¿«é€Ÿæ’åºä¸€æ¬¡ï¼Œæ‰¾ç¬¬10000-nå¤§çš„æ•°å­—ï¼›é€’å½’ä»¥ä¸Šè¿‡ç¨‹ï¼Œå°±å¯ä»¥æ‰¾åˆ°ç¬¬1wå¤§çš„æ•°ã€‚å‚è€ƒä¸Šé¢çš„æ‰¾å‡ºç¬¬1wå¤§æ•°å­—ï¼Œå°±å¯ä»¥ç±»ä¼¼çš„æ–¹æ³•æ‰¾åˆ°å‰10000å¤§æ•°å­—äº†ã€‚æ­¤ç§æ–¹æ³•éœ€è¦æ¯æ¬¡çš„å†…å­˜ç©ºé—´ä¸º10^6*4=4MBï¼Œä¸€å…±éœ€è¦101æ¬¡è¿™æ ·çš„æ¯”è¾ƒã€‚ 

ç¬¬å››ç§æ–¹æ³•æ˜¯Hashæ³•ã€‚å¦‚æœè¿™1äº¿ä¸ªä¹¦é‡Œé¢æœ‰å¾ˆå¤šé‡å¤çš„æ•°ï¼Œå…ˆé€šè¿‡Hashæ³•ï¼ŒæŠŠè¿™1äº¿ä¸ªæ•°å­—å»é‡å¤ï¼Œè¿™æ ·å¦‚æœé‡å¤ç‡å¾ˆé«˜çš„è¯ï¼Œä¼šå‡å°‘å¾ˆå¤§çš„å†…å­˜ç”¨é‡ï¼Œä»è€Œç¼©å°è¿ç®—ç©ºé—´ï¼Œç„¶åé€šè¿‡åˆ†æ²»æ³•æˆ–æœ€å°å †æ³•æŸ¥æ‰¾æœ€å¤§çš„10000ä¸ªæ•°ã€‚

ç¬¬äº”ç§æ–¹æ³•é‡‡ç”¨æœ€å°å †ã€‚é¦–å…ˆè¯»å…¥å‰10000ä¸ªæ•°æ¥åˆ›å»ºå¤§å°ä¸º10000çš„æœ€å°å †ï¼Œå»ºå †çš„æ—¶é—´å¤æ‚åº¦ä¸ºOï¼ˆmlogmï¼‰ï¼ˆmä¸ºæ•°ç»„çš„å¤§å°å³ä¸º10000ï¼‰ï¼Œç„¶åéå†åç»­çš„æ•°å­—ï¼Œå¹¶äºå †é¡¶ï¼ˆæœ€å°ï¼‰æ•°å­—è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœæ¯”æœ€å°çš„æ•°å°ï¼Œåˆ™ç»§ç»­è¯»å–åç»­æ•°å­—ï¼›å¦‚æœæ¯”å †é¡¶æ•°å­—å¤§ï¼Œåˆ™æ›¿æ¢å †é¡¶å…ƒç´ å¹¶é‡æ–°è°ƒæ•´å †ä¸ºæœ€å°å †ã€‚æ•´ä¸ªè¿‡ç¨‹ç›´è‡³1äº¿ä¸ªæ•°å…¨éƒ¨éå†å®Œä¸ºæ­¢ã€‚ç„¶åæŒ‰ç…§ä¸­åºéå†çš„æ–¹å¼è¾“å‡ºå½“å‰å †ä¸­çš„æ‰€æœ‰10000ä¸ªæ•°å­—ã€‚è¯¥ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸ºOï¼ˆnmlogmï¼‰ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯10000ï¼ˆå¸¸æ•°ï¼‰ã€‚
```









> 1ã€æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯å¿«æ’ï¼Œå–topk
>
> 2ã€å±€éƒ¨æ·˜æ±°æ³•ã€‚ç”¨ä¸€ä¸ªå®¹å™¨ä¿å­˜å‰kä¸ªæ•°ï¼Œç„¶åå°†å‰©ä½™çš„æ‰€æœ‰æ•°å­—â€”â€”ä¸å®¹å™¨å†…çš„æœ€å°æ•°å­—ç›¸æ¯”ï¼Œå¦‚æœæ‰€æœ‰åç»­çš„å…ƒç´ éƒ½æ¯”å®¹å™¨å†…çš„kä¸ªæ•°è¿˜å°ï¼Œé‚£ä¹ˆå®¹å™¨å†…è¿™kä¸ªæ•°å°±æ˜¯æœ€å¤§kä¸ªæ•°ã€‚å¦‚æœæŸä¸€åç»­å…ƒç´ æ¯”å®¹å™¨å†…æœ€å°æ•°å­—å¤§ï¼Œåˆ™åˆ æ‰å®¹å™¨å†…æœ€å°å…ƒç´ ï¼Œå¹¶å°†è¯¥å…ƒç´ æ’å…¥å®¹å™¨ï¼Œæœ€åéå†å®Œæ‰€æœ‰çš„æ•°ï¼Œå¾—åˆ°çš„ç»“æœå®¹å™¨ä¸­ä¿å­˜çš„æ•°å³ä¸ºæœ€ç»ˆç»“æœäº†
>
> 3ã€åˆ†æ²»æ³•ã€‚å°†1äº¿ä¸ªæ•°æ®åˆ†æˆ100ä»½ï¼Œæ¯ä»½100ä¸‡ä¸ªæ•°æ®ï¼Œæ‰¾åˆ°æ¯ä»½æ•°æ®ä¸­æœ€å¤§çš„10000ä¸ªï¼Œæœ€ååœ¨å‰©ä¸‹çš„100* *10000ä¸ªæ•°æ®é‡Œé¢æ‰¾å‡ºæœ€å¤§çš„10000ä¸ªã€‚100ä¸‡ä¸ªæ•°æ®é‡Œé¢æŸ¥æ‰¾æœ€å¤§çš„10000ä¸ªæ•°æ®çš„æ–¹æ³•å¦‚ä¸‹ï¼šç”¨å¿«é€Ÿæ’åºçš„æ–¹æ³•ï¼Œå°†æ•°æ®åˆ†ä¸º2å †ï¼Œå¦‚æœå¤§çš„é‚£å †ä¸ªæ•°Nå¤§äº10000ä¸ªï¼Œç»§ç»­å¯¹å¤§å †å¿«é€Ÿæ’åºä¸€æ¬¡åˆ†æˆ2å †ï¼Œå¦‚æœå¤§çš„é‚£å †ä¸ªæ•°Nå¤§äº10000ä¸ªï¼Œç»§ç»­å¯¹å¤§å †å¿«é€Ÿæ’åºä¸€æ¬¡åˆ†æˆ2å †ï¼Œå¦‚æœå¤§å †ä¸ªæ•°Nå°äº10000ä¸ªï¼Œå°±åœ¨å°çš„é‚£å †é‡Œé¢å¿«é€Ÿæ’åºä¸€æ¬¡ï¼Œæ‰¾ç¬¬10000-nå¤§çš„æ•°å­—ï¼›é€’å½’ä»¥ä¸Šè¿‡ç¨‹ï¼Œå°±å¯ä»¥æ‰¾åˆ°ç¬¬1wå¤§çš„æ•°ã€‚å‚è€ƒä¸Šé¢çš„æ‰¾å‡ºç¬¬1wå¤§æ•°å­—ï¼Œå°±å¯ä»¥ç±»ä¼¼çš„æ–¹æ³•æ‰¾åˆ°å‰10000å¤§æ•°å­—äº†ã€‚æ­¤ç§æ–¹æ³•éœ€è¦æ¯æ¬¡çš„å†…å­˜ç©ºé—´ä¸º10^6*4=4MBï¼Œä¸€å…±éœ€è¦101æ¬¡è¿™æ ·çš„æ¯”è¾ƒã€‚
>
> 4ã€é‡‡ç”¨æœ€å°å †ã€‚é¦–å…ˆè¯»å…¥å‰10000ä¸ªæ•°æ¥åˆ›å»ºå¤§å°ä¸º10000çš„æœ€å°å †ï¼Œå»ºå †çš„æ—¶é—´å¤æ‚åº¦ä¸ºOï¼ˆmlogmï¼‰ï¼ˆmä¸ºæ•°ç»„çš„å¤§å°å³ä¸º10000ï¼‰ï¼Œç„¶åéå†åç»­çš„æ•°å­—ï¼Œå¹¶äºå †é¡¶ï¼ˆæœ€å°ï¼‰æ•°å­—è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœæ¯”æœ€å°çš„æ•°å°ï¼Œåˆ™ç»§ç»­è¯»å–åç»­æ•°å­—ï¼›å¦‚æœæ¯”å †é¡¶æ•°å­—å¤§ï¼Œåˆ™æ›¿æ¢å †é¡¶å…ƒç´ å¹¶é‡æ–°è°ƒæ•´å †ä¸ºæœ€å°å †ã€‚æ•´ä¸ªè¿‡ç¨‹ç›´è‡³1äº¿ä¸ªæ•°å…¨éƒ¨éå†å®Œä¸ºæ­¢ã€‚ç„¶åæŒ‰ç…§ä¸­åºéå†çš„æ–¹å¼è¾“å‡ºå½“å‰å †ä¸­çš„æ‰€æœ‰10000ä¸ªæ•°å­—ã€‚è¯¥ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸ºOï¼ˆnmlogmï¼‰ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯10000ï¼ˆå¸¸æ•°ï¼‰ã€‚



## æµ·é‡æ•°æ®å»é‡

æœ‰ä¸ªé¢è¯•é¢˜ï¼š è¯·é—®æœ‰40äº¿ä¸ªqqå·å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œé¢ã€‚å¦‚ä½•æ‰¾å‡ºé‡å¤æ•°é‡æœ€å¤šçš„å‰40ä¸ªã€‚è¦æ±‚åªç”¨10må†… å­˜ã€‚

- 1.å…ˆåˆ†è€Œæ²»ä¹‹å°†40äº¿qqå·åˆ’åˆ†ä¸ºå¤šä¸ªå­æ¨¡å—å¿«æ’å­˜å‚¨åˆ°å¤šä¸ªæ–‡ä»¶ä¸­ã€‚
-  2.ç„¶åä½¿ç”¨æœ‰é™çš„å†…å­˜åˆå¹¶å¤šä¸ªå­æ–‡ä»¶ã€‚ï¼ˆå½’å¹¶æˆ–è€…çŠ¶æ€æœºï¼‰ã€‚
-  3.æœ€åè·å–åˆ°å®Œæ•´çš„æ’åºæ–‡ä»¶ã€‚ 
- 4.ä½¿ç”¨ä½å›¾æˆ–è€…æ’åºæ ‘æ¥ç­›é€‰å‰40ä½ã€‚



## æµ·é‡æ•°æ®æ‰¾ä¸­ä½æ•°

**csdné“¾æ¥ï¼š**

https://blog.csdn.net/stpeace/article/details/108921752#:~:text=%E5%85%B7%E4%BD%93%E6%AD%A5%E9%AA%A4%E5%A6%82%E4%B8%8B%EF%BC%9A%20Step1%3A,%E5%88%9B%E5%BB%BA%E5%A4%9A%E4%B8%AA%E5%B0%8F%E6%96%87%E4%BB%B6%E6%A1%B6%EF%BC%8C%E8%AE%BE%E5%AE%9A%E6%AF%8F%E4%B8%AA%E6%A1%B6%E7%9A%84%E5%8F%96%E5%80%BC%E8%8C%83%E5%9B%B4%EF%BC%8C%E7%84%B6%E5%90%8E%E6%8A%8A%E6%B5%B7%E9%87%8F%E6%95%B0%E6%8D%AE%E5%85%83%E7%B4%A0%E5%88%86%E9%85%8D%E5%88%B0%E5%AF%B9%E5%BA%94%E7%9A%84%E6%A1%B6%E4%B8%AD%EF%BC%8C%E5%B9%B6%E8%AE%B0%E5%BD%95%E6%A1%B6%E4%B8%AD%E5%85%83%E7%B4%A0%E7%9A%84%E4%B8%AA%E6%95%B0%E3%80%82%20Step2%3A%20%E6%A0%B9%E6%8D%AE%E6%A1%B6%E4%B8%AD%E5%85%83%E7%B4%A0%E7%9A%84%E4%B8%AA%E6%95%B0%EF%BC%8C%E8%AE%A1%E7%AE%97%E5%87%BA%E4%B8%AD%E4%BD%8D%E6%95%B0%E6%89%80%E5%9C%A8%E7%9A%84%E6%A1%B6%EF%BC%8C%E7%84%B6%E5%90%8E%E9%92%88%E5%AF%B9%E8%AF%A5%E6%A1%B6%E8%BF%9B%E8%A1%8C%E6%8E%92%E5%BA%8F%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E6%B1%82%E5%87%BA%E6%B5%B7%E9%87%8F%E6%95%B0%E6%8D%AE%E4%B8%AD%E4%BD%8D%E6%95%B0%E7%9A%84%E5%80%BC%E3%80%82




   Step1: åˆ›å»ºå¤šä¸ªå°æ–‡ä»¶æ¡¶ï¼Œè®¾å®šæ¯ä¸ªæ¡¶çš„å–å€¼èŒƒå›´ï¼Œç„¶åæŠŠæµ·é‡æ•°æ®å…ƒç´ åˆ†é…åˆ°å¯¹åº”çš„æ¡¶ä¸­ï¼Œå¹¶è®°å½•æ¡¶ä¸­å…ƒç´ çš„ä¸ªæ•°ã€‚

   Step2: æ ¹æ®æ¡¶ä¸­å…ƒç´ çš„ä¸ªæ•°ï¼Œè®¡ç®—å‡ºä¸­ä½æ•°æ‰€åœ¨çš„æ¡¶ï¼Œç„¶åé’ˆå¯¹è¯¥æ¡¶è¿›è¡Œæ’åºï¼Œå°±å¯ä»¥æ±‚å‡ºæµ·é‡æ•°æ®ä¸­ä½æ•°çš„å€¼ã€‚





**çŸ¥ä¹å¼•ç”¨**ï¼šhttps://zhuanlan.zhihu.com/p/75397875



è¿˜å¯ä»¥çœ‹çœ‹ç¨‹åºä»£ç ä¹¦





## æµ·é‡æ•°æ®æ‰¾æœ€å¤§çš„10ä¸ªï¼ˆä¸å…è®¸ç”¨å †ï¼‰

![8a0060aa91a1e4358b57dc55d6a8a68.jpg](https://uploadfiles.nowcoder.com/images/20220901/318712518_1662040463175/837D1009E7FBDF0A15A8DCBEFC5A8767?x-oss-process=image%2Fresize%2Cm_mfit%2Cw_550%2Ch_550)



æ¯”ç‰¹ä½åˆ†æ²»ï¼Œå†…éƒ¨æ’åº















## å¦‚ä½•ä»å¤§é‡çš„ URL ä¸­æ‰¾å‡ºç›¸åŒçš„ URL





### [é¢˜ç›®æè¿°](https://doocs.github.io/advanced-java/#/docs/big-data/find-common-urls?id=é¢˜ç›®æè¿°)

ç»™å®š aã€b ä¸¤ä¸ªæ–‡ä»¶ï¼Œå„å­˜æ”¾ 50 äº¿ä¸ª URLï¼Œæ¯ä¸ª URL å„å  64Bï¼Œå†…å­˜é™åˆ¶æ˜¯ 4Gã€‚è¯·æ‰¾å‡º aã€b ä¸¤ä¸ªæ–‡ä»¶å…±åŒçš„ URLã€‚















# Redis



## Redisè·³è¡¨å®ç°



```java
class Skiplist {
    /*
    Redisåº•å±‚æ•°æ®ç»“æ„:è·³è¡¨->ä»¥O(logN)çš„æ—¶é—´å¤æ‚åº¦å†…å®Œæˆå¢åˆ æ”¹æŸ¥æŒ‡å®šå…ƒç´ 
    æ ¸å¿ƒåŸç†:å»ºç«‹å¤šå±‚éšæœºç´¢å¼•,å°†æ—¶é—´å¤æ‚åº¦é™è‡³logN,å…·ä½“å¯å‚è€ƒç®€ä¹¦çš„åšå®¢
    é‡è¦å‡½æ•°:1.findClosest(node,level,num) (ä»curNodeå¼€å§‹)å¯»æ‰¾levelå†…æœ€é è¿‘targetçš„å·¦è¾¹èŠ‚ç‚¹
            è¯¥ä½ç½®å°±æ˜¯åœ¨è¯¥å±‚å†…æœ€æ¥è¿‘targetä¸”<targetçš„ä½ç½®,å°†æ¥ç”¨äºå®Œæˆæ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾ç­‰æ“ä½œ
            2.randomLevel() ä»¥0.25ä¸ºæ¦‚ç‡å› å­ç”Ÿæˆæœ€å¤§å€¼ä¸º32çš„éšæœºæ•°
            æ•°å­—æ¯å¢åŠ 1,å‡ºç°çš„æ¦‚ç‡ä¸ºå‰ä¸€ä¸ªæ•°çš„0.25å€
            å¦‚:1å‡ºç°çš„æ¦‚ç‡ä¸º0.75;1ä»¥ä¸Šå‡ºç°çš„æ¦‚ç‡ä¸º0.25;
            2å‡ºç°çš„æ¦‚ç‡å°±æ˜¯0.25*0.75;3å‡ºç°çš„æ¦‚ç‡å°±æ˜¯0.25*0.75*0.75
            .......è¿™æ ·å¯ä»¥é—´æ¥ä¿è¯æ¯ä¸€å±‚çš„å…ƒç´ æˆç±»ä¼¼äºäºŒå‰æ ‘çš„ç»“æ„,æœ€å¤§é«˜åº¦ä¸è¿‡logN
    */
    // éšæœºæ•°æ¦‚ç‡å› å­
    private static final double P_FACTOR = 0.25;
    // æœ€å¤§å±‚æ•°
    private static final int MAX_LEVEL = 32;
    // å½“å‰å®é™…æœ‰æ•ˆçš„æœ€å¤§å±‚æ•°
    private int curLevel;
    // å¤´ç»“ç‚¹
    Node head;

    /*
    èŠ‚ç‚¹ç±»:å€¼+åŒå±‚å³è¾¹çš„èŠ‚ç‚¹å¼•ç”¨æ•°ç»„
    */
    class Node {
        int val;
        Node[] next;//æ¯ä¸ªç»“ç‚¹ï¼Œæ¯ä¸€å±‚å¯¹åº”çš„ä¸‹ä¸€ä¸ªç»“ç‚¹ï¼Œä»¥æ•°ç»„å­˜å‚¨
        
        public Node(int _val, int level) {
            val = _val;
            next = new Node[level];
        }
    }

    /*
    ç”¨ç»™å®šè§„åˆ™ç”Ÿæˆéšæœºæ•°(éé™æ€æ–¹æ³•ä¹Ÿå¯ä»¥è°ƒç”¨é™æ€å˜é‡)
    */
    private int randomLevel() {
        // å±‚æ•°levelä»1å¼€å§‹
        int level = 1;
        while(Math.random() < P_FACTOR && level < MAX_LEVEL) {
            level++;
        }
        return level;
    }

    /*
    è·³è¡¨æ„é€ å™¨
    */
    public Skiplist() {
        // ä¸€å¼€å§‹å•¥ä¹Ÿæ²¡
        curLevel = 0;
        // headæŒ‡å‡º32ä¸ªnextçš„èŠ‚ç‚¹
        head = new Node(-1, MAX_LEVEL);
    }
    
    /*
    ä»curNodeå¼€å§‹:
    å¯»æ‰¾levelå±‚å†…æœ€é è¿‘targetçš„å·¦è¾¹èŠ‚ç‚¹(å¦‚target=6,5->6->7,åœç•™åœ¨5;å¦‚target=6,5->7->8,åœç•™åœ¨5)
    */
    private Node findClosest(Node curNode, int level, int target) {
        // curNodeå°±æ˜¯ä¸Šä¸€å±‚ä¸‹æ²‰ä½ç½®çš„å¼€ç«¯
        while(curNode.next[level] != null && curNode.next[level].val < target) {
            curNode = curNode.next[level];
        }
        return curNode;
    }

    /*
    æŸ¥æ‰¾è·³è¡¨å†…æ˜¯å¦å­˜åœ¨targetå…ƒç´ 
    */
    public boolean search(int target) {
        Node curNode = head;
        // ä»æœ‰æ•ˆçš„é¡¶å±‚å¼€å§‹æœç´¢
        for(int i = curLevel - 1; i >= 0; i--) {
            // searchNodeåœç•™åœ¨<=targetçš„å·¦è¾¹
            curNode = findClosest(curNode, i, target);
            if(curNode.next[i] != null && curNode.next[i].val == target) {
                // æ‰¾åˆ°ä¸€ä¸ªå³å¯è¿”å›true
                return true;
            }
        }
        // æ‰¾éæ‰€æœ‰å±‚éƒ½æ‰¾ä¸åˆ°å°±è¿”å›false
        return false;
    }
    
    /*
    å¾€è·³è¡¨å†…æ·»åŠ å…ƒç´ num
    */
    public void add(int num) {
        // éšæœºå±‚
        int level = randomLevel();
        // éšæœºå±‚å¯¹åº”çš„æ–°èŠ‚ç‚¹
        Node newNode = new Node(num, level);
        Node curNode = head;
        for(int i = curLevel - 1; i >= 0; i--) {
            // æ‰¾åˆ°è¦æ’å…¥çš„ä½ç½®
                //åœ¨æ¯å±‚æ‰¾åˆ°æœ€é è¿‘targetçš„å·¦ç»“ç‚¹
            curNode = findClosest(curNode, i, num);
            // å½“å‰å±‚<newNodeè¦æ±‚çš„å±‚æ•°æ—¶,æ¯ä¸€å±‚å‡è¦è¿›è¡Œæ’å…¥æ“ä½œ
            // å¦‚level=2æ—¶,åªè¦æ±‚ç´¢å¼•ä¸º0,1çš„å±‚è¿›è¡Œæ’å…¥
            if(i < level) {
                if(curNode.next[i] == null) {
                    // ç›®æ ‡ä½ç½®å¤„ä¸ºç©ºç›´æ¥æ¥ä¸Š
                    curNode.next[i] = newNode;
                }else {
                    // å¦åˆ™å°±è¦è¿›è¡Œæ ‡å‡†æ’å…¥æ“ä½œ
                    Node tmp = curNode.next[i];
                    curNode.next[i] = newNode;
                    newNode.next[i] = tmp;
                }
            }
        }
        // æ­¤æ—¶æœ‰å¯èƒ½è¦æ›´æ–°curLevel
          //æ­¤æ—¶æœ‰å¯èƒ½è¦æ›´æ–°curLevel,å› ä¸ºæœ‰å¯èƒ½éšæœºå±‚å¤§äºæœ€å¤§æœ‰æ•ˆå±‚,é‚£å°±å•æ‰“æŠŠå¤§äºæœ‰æ•ˆå±‚çš„ç´¢å¼•åŠ å…¥
        if(level > curLevel) {
            for(int i = curLevel; i < level; i++) {
                head.next[i] = newNode;
            }
            curLevel = level;
        }
    }
    
    /*
    å¾€è·³è¡¨å†…åˆ é™¤å…ƒç´ num
    */
    public boolean erase(int num) {
        Node curNode = head;
        // åˆ é™¤æˆåŠŸæ ‡è®°
        boolean flag = false;
        for(int i = curLevel - 1; i >= 0; i--) {
            curNode = findClosest(curNode, i, num);
            // å¯èƒ½æœ‰å¤šä¸ªç›¸åŒçš„å€¼(å¦‚æœå­˜åœ¨å¤šä¸ªnumåˆ é™¤å…¶ä¸­ä»»æ„ä¸€ä¸ªå³å¯)
            // å½“å‡ºç°å¤šä¸ªé‡å¤å€¼ä¸”å‰é¢èŠ‚ç‚¹å±‚æ•°ä½åé¢å±‚æ•°é«˜,ä¸€å±‚ä¸€å±‚åˆ ä¸‹æ¥å…¶å®åˆ é™¤çš„ä¸æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹
            // ä½†æ˜¯ä¸ä¼šå½±å“æœ€ç»ˆç»“æœ
            if(curNode.next[i] != null && curNode.next[i].val == num) {
                // è¿›è¡Œåˆ é™¤æ“ä½œ
                curNode.next[i] = curNode.next[i].next[i];
                // æ ‡è®°åˆ é™¤æˆåŠŸ
                flag = true;
            }
        }
        return flag;
    }
}
```

### å¹¶å‘å®‰å…¨ç‰ˆæœ¬

ç”¨CASæ¥å®ç°å¹¶å‘å®‰å…¨ï¼Œä¾‹å¦‚findClosestæ‰¾åˆ°åœ¨æ¯å±‚æ‰¾åˆ°æœ€é è¿‘targetçš„å·¦ç»“ç‚¹åï¼ˆè®¾è¿™ä¸ªç»“ç‚¹å«nodeï¼‰ï¼ŒCASçš„æ›¿æ¢è¿™ä¸ªnode.next,ä¾æ¬¡æ¥è¾¾åˆ°å¹¶å‘å®‰å…¨ã€‚





## Rediså®ç°å»¶æ—¶é˜Ÿåˆ—



### åœºæ™¯

1.å¯¹äºçº¢åŒ…åœºæ™¯ï¼Œè´¦æˆ· A å¯¹è´¦æˆ· B å‘å‡ºçº¢åŒ…é€šå¸¸åœ¨ 1 å¤©åä¼šè‡ªåŠ¨å½’è¿˜åˆ°åŸè´¦æˆ·ã€‚

2.å¯¹äºå®æ—¶æ”¯ä»˜åœºæ™¯ï¼Œå¦‚æœè´¦æˆ· A å¯¹å•†æˆ· S ä»˜æ¬¾ 100 å…ƒï¼Œ5ç§’åæ²¡æœ‰æ”¶åˆ°æ”¯ä»˜æ–¹å›è°ƒå°†è‡ªåŠ¨å–æ¶ˆè®¢å•ã€‚



### è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼š

é‡‡ç”¨é€šè¿‡å®šæ—¶ä»»åŠ¡é‡‡ç”¨æ•°æ®åº“/éå…³ç³»å‹æ•°æ®åº“è½®è¯¢æ–¹æ¡ˆã€‚

ä¼˜ç‚¹ï¼š

- å®ç°ç®€å•ï¼Œå¯¹äºé¡¹ç›®å‰æœŸè¿™æ ·æ˜¯æœ€å®¹æ˜“çš„è§£å†³æ–¹æ¡ˆã€‚

ç¼ºç‚¹ï¼š

1. DB æœ‰æ•ˆä½¿ç”¨ç‡ä½ï¼Œéœ€è¦å°†ä¸€éƒ¨åˆ†çš„æ•°æ®åº“çš„QPSåˆ†é…ç»™ JOB çš„æ— æ•ˆè½®è¯¢ã€‚
2. æœåŠ¡èµ„æºæµªè´¹ï¼Œå› ä¸ºè½®è¯¢éœ€è¦å¯¹æ‰€æœ‰çš„æ•°æ®åšä¸€æ¬¡ SCAN æ‰«æ JOB æœåŠ¡çš„èµ„æºå¼€é”€å¾ˆå¤§ã€‚

### æ–¹æ¡ˆäºŒï¼š

é‡‡ç”¨å»¶è¿Ÿé˜Ÿåˆ—ï¼š

ä¼˜ç‚¹ï¼š

1.  æœåŠ¡çš„èµ„æºä½¿ç”¨ç‡è¾ƒé«˜ï¼Œèƒ½å¤Ÿç²¾ç¡®çš„å®ç°è¶…æ—¶ä»»åŠ¡çš„æ‰§è¡Œã€‚
2. å‡å°‘ DB çš„æŸ¥è¯¢æ¬¡æ•°ï¼Œèƒ½å¤Ÿé™ä½æ•°æ®åº“çš„å‹åŠ›

ç¼ºç‚¹ï¼š

- å¯¹äºå»¶è¿Ÿé˜Ÿåˆ—æ¥è¯´æœ¬èº«è®¾è®¡æ¯”è¾ƒå¤æ‚ï¼Œç›®å‰æ²¡æœ‰é€šç”¨çš„æ¯”è¾ƒå¥½è¿‡çš„æ–¹æ¡ˆã€‚





**ä¸‹é¢ä¸ºrediså»¶æ—¶é˜Ÿåˆ—å®ç°**



å…ˆæ¥çœ‹ä¸¤ä¸ªrediså‘½ä»¤

 Zrangebyscoreå‘½ä»¤ï¼šè¿”å›æœ‰åºé›† key ä¸­ï¼Œæ‰€æœ‰ score å€¼ä»‹äº min å’Œ max ä¹‹é—´(åŒ…æ‹¬ç­‰äº min æˆ– max )çš„æˆå‘˜





```Redis
//è¿”å›æ‰€æœ‰ç¬¦åˆæ¡ä»¶ 1 < score <= 5 çš„æˆå‘˜
ZRANGEBYSCORE zset (1 5

//è¿”å›æ‰€æœ‰ç¬¦åˆæ¡ä»¶ 1 < score <= 5 çš„æˆå‘˜
ZRANGEBYSCORE zset (5 (10
```



### æ€è·¯

æŠŠå½“å‰æ—¶é—´æˆ³å’Œå»¶æ—¶æ—¶é—´ç›¸åŠ ï¼Œä¹Ÿå°±æ˜¯åˆ°æœŸæ—¶é—´ï¼Œå­˜å…¥Redisä¸­ï¼Œç„¶åä¸æ–­è½®è¯¢ï¼Œæ‰¾åˆ°åˆ°æœŸçš„ï¼Œæ‹¿åˆ°å†åˆ é™¤å³å¯ã€‚



![img](../../images/Redis/509087-20200404111242306-943787231.png)











ä½¿ç”¨RedisTemplateä½œä¸ºRediså®¢æˆ·ç«¯è¿æ¥,æ”¾åœ¨å»¶æ—¶é˜Ÿåˆ—ä¸­çš„å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªä¸ªå»¶æ—¶ä»»åŠ¡ã€‚





```java
@Data
public class DelayTask<T> {
	// æ¶ˆæ¯id
    private String id;
    // ä»»åŠ¡åç§°
    private String taskName;
    // å…·ä½“ä»»åŠ¡å†…å®¹
    private T msg;

}

```



**å»¶æ—¶é˜Ÿåˆ—å…·ä½“å®ç°ï¼Œä¸»è¦åˆ†ä¸ºæ”¾ä»»åŠ¡å’Œè½®è¯¢ä»»åŠ¡ä¸¤ä¸ªéƒ¨åˆ†**



### æ”¾ä»»åŠ¡+è½®è¯¢ä»»åŠ¡

```java
public class RedisDelayQueue<T> {
    /**
     * å»¶è¿Ÿé˜Ÿåˆ—åç§°
     */
    private String delayQueueName = "delayQueue";
  
    // ä¼ å…¥rediså®¢æˆ·ç«¯æ“ä½œ
    public RedisDelayQueue(RedisTemplate redisTemplate,String delayQueueName)
    {
        this.redisTemplate = redisTemplate;
        this.delayQueueName = delayQueueName;
    }
    /**
     * è®¾ç½®å»¶è¿Ÿæ¶ˆæ¯
     */
    public void setDelayTasks(T msg, long delayTime) {
        DelayTask<T> delayTask = new DelayTask<>();
        delayTask.setId(UUID.randomUUID().toString());
        delayTask.setMsg(msg);
        
        //socreä¸ºå½“å‰æ—¶é—´+å»¶æ—¶æ—¶é—´
        Boolean addResult = redisTemplate.opsForZSet().add(delayQueueName, JSONObject.toJSONString(delayTask), System.currentTimeMillis() + delayTime);
        if(addResult)
        {
            System.out.println("æ·»åŠ ä»»åŠ¡æˆåŠŸï¼"+JSONObject.toJSONString(delayTask)+"å½“å‰æ—¶é—´ä¸º"+ LocalDateTime.now());
        }
    }
    /**
     * ç›‘å¬å»¶è¿Ÿæ¶ˆæ¯
     */
    public void listenDelayLoop() {
        while (true) {
            // è·å–ä¸€ä¸ªåˆ°ç‚¹çš„æ¶ˆæ¯
            
            //æ‹¿æ¯”å½“å‰æ—¶é—´å‰ä¸€ç‚¹çš„ä¸€æ¡æ•°æ®è¿›è¡Œæ¶ˆè´¹ï¼ŒæŸ¥è¯¢æœ€æ—©çš„ä¸€æ¡ä»»åŠ¡ï¼Œæ¥è¿›è¡Œæ¶ˆè´¹
            Set<String> set = redisTemplate.opsForZSet().rangeByScore(delayQueueName, 0, System.currentTimeMillis(), 0, 1);

            // å¦‚æœæ²¡æœ‰ï¼Œå°±ç­‰ç­‰
            if (set.isEmpty()) {
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                // ç»§ç»­æ‰§è¡Œ
                continue;
            }
            // è·å–å…·ä½“æ¶ˆæ¯çš„key
            String it = set.iterator().next();
            // åˆ é™¤æˆåŠŸï¼Œzremå‘½ä»¤åˆ é™¤zseté‡Œé¢çš„value
            if (redisTemplate.opsForZSet().remove(delayQueueName, it) > 0) {
                // æ‹¿åˆ°ä»»åŠ¡
                DelayTask delayTask = JSONObject.parseObject(it, DelayTask.class);
                // åç»­å¤„ç†
                System.out.println("æ¶ˆæ¯åˆ°æœŸ"+delayTask.getMsg().toString()+",æ—¶é—´ä¸º"+LocalDateTime.now());
            }
        }
    }
}

```







### luaè„šæœ¬

ä¸Šé¢çš„ç®—æ³•ä¸­åŒä¸€ä¸ªä»»åŠ¡å¯èƒ½ä¼šè¢«å¤šä¸ªè¿›ç¨‹å–åˆ°ä¹‹åå†ä½¿ç”¨ zrem è¿›è¡Œäº‰æŠ¢ï¼Œé‚£äº›æ²¡æŠ¢åˆ° çš„è¿›ç¨‹éƒ½æ˜¯ç™½å–äº†ä¸€æ¬¡ä»»åŠ¡ï¼Œè¿™æ˜¯æµªè´¹ã€‚å¯ä»¥è€ƒè™‘ä½¿ç”¨ lua scripting æ¥ä¼˜åŒ–ä¸€ä¸‹è¿™ä¸ªé€»è¾‘ï¼Œå°† zrangebyscore å’Œ zrem ä¸€åŒæŒªåˆ°æœåŠ¡å™¨ç«¯è¿›è¡ŒåŸå­åŒ–æ“ä½œï¼Œè¿™æ ·å¤šä¸ªè¿›ç¨‹ä¹‹é—´äº‰æŠ¢ä»»åŠ¡æ—¶å°±ä¸ ä¼šå‡ºç°è¿™ç§æµªè´¹äº†















# æ‰‹å†™çº¿ç¨‹æ± 

è¿™ä¸ªå…ˆç­‰ä¸€ä¼š

ç®€æ˜“ç‰ˆçº¿ç¨‹æ± 

**æ ¸å¿ƒçº¿ç¨‹æ•°**

**æœ€å¤§çº¿ç¨‹æ•°**

**å·¥ä½œé˜Ÿåˆ—**



```java
package çº¿ç¨‹æ± ;

import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.Executor;
import java.util.concurrent.atomic.AtomicInteger;

public class ThreadPoolTrader implements Executor {

    //å½“å‰çº¿ç¨‹æ± æœ‰å¤šå°‘ä¸ªçº¿ç¨‹
    public final AtomicInteger ctl = new AtomicInteger(0);

    //æ ¸å¿ƒçº¿ç¨‹
    private volatile int cornPollSize;

    //æœ€å¤§çº¿ç¨‹
    private volatile int maximumPollSize;

    //å·¥ä½œé˜Ÿåˆ—

    private final BlockingQueue<Runnable> workQueue;

    public ThreadPoolTrader(int cornPollSize, int maximumPollSize, BlockingQueue<Runnable> workQueue) {
        this.cornPollSize = cornPollSize;
        this.maximumPollSize = maximumPollSize;
        this.workQueue = workQueue;
    }



    @Override
    public void execute(Runnable command) {

        int c = ctl.get();
        if(c < cornPollSize) {
            if(!addWorker(command)) {
                reject();
            }
        }
        /**
         * å…ˆæœ›å·¥ä½œé˜Ÿåˆ—é‡Œé¢æäº¤
         *
         * å¦‚æœå·¥ä½œé˜Ÿåˆ—æ»¡äº†ï¼Œå°è¯•åˆ›å»ºæ–°çº¿ç¨‹ï¼ˆåªè¦ä¸å¤§äºmaxmumPoolSizeï¼‰
         */
        if(!workQueue.offer(command)) {
            if(!addWorker(command)) {
                reject();
            }
        }

    }

    private boolean addWorker(Runnable command) {
        if(ctl.get() > maximumPollSize) return  false;

        //åˆ›å»ºworkerç±»ï¼Œå¹¶å¸¦ç€ä»»åŠ¡Runnable
        Worker worker = new Worker(command);
        worker.thread.start();
        ctl.incrementAndGet();
        return true;


    }






    //workerç±»
    private final class Worker implements Runnable{

        final Thread thread;
        Runnable firstTask;

        private Worker(Runnable firstTask) {
            this.thread = new Thread(this);
            this.firstTask = firstTask;
        }



        @Override
        public void run() {

            Runnable task = firstTask;
            try {
                //æäº¤çš„ä»»åŠ¡å®Œæˆä¹‹åå¼€å§‹ä»é˜Ÿåˆ—é‡Œé¢æ‹¿ä»»åŠ¡
                while(task != null || (task = getTask()) != null) {
                        task.run();
                        if(ctl.get() > maximumPollSize) {
                            break;
                        }
                       task = null;
                }

            } finally {
                        ctl.decrementAndGet();
            }

        }

        /**
         * ä»å·¥ä½œé˜Ÿåˆ—é‡Œé¢æ‹¿ä»»åŠ¡
         * @return
         */
        private Runnable getTask() {
            for(; ;) {
                try {
                    System.out.println("workQueue.sizeï¼š" + workQueue.size());
                    return workQueue.take();
                } catch (InterruptedException  e) {
                    e.printStackTrace();
                }
            }
        }

    }


    private void reject() {
        throw new RuntimeException("Errorï¼ctl.countï¼š" + ctl.get() + " workQueue.sizeï¼š" + workQueue.size());
    }

    public static void main(String[] args) {
        ThreadPoolTrader threadPoolTrader = new ThreadPoolTrader(2, 2, new ArrayBlockingQueue<Runnable>(10));

        for(int i = 0; i < 10; i++) {

            int x = i;
            threadPoolTrader.execute(() -> {

                System.out.println("ä»»åŠ¡ç¼–å·" + x);
            });
        }

    }


}
```





# ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•

**ç›´æ¥å°æ—å“¥**

https://xiaolincoding.com/os/8_network_system/hash.html#%E5%A6%82%E4%BD%95%E5%88%86%E9%85%8D%E8%AF%B7%E6%B1%82





